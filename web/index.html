              <div>
                ${
                  isCurrentUserOwner
                    ? '<div style="color: #ffd866; font-size: 0.85rem;">您可以执行所有者特权操作</div>'
                    : '<div style="color: #f38a96; font-size: 0.85rem;">您不是合约所有者</div>'
                }
              </div>
            </div>
          `;

          $ownerInfo.html(ownerDisplay);

          // 如果当前用户不是所有者，禁用转移到所有者按钮
          if (!isCurrentUserOwner) {
            $transferToOwnerBtn.prop("disabled", true);
            $transferToOwnerBtn.css("opacity", 0.5);
          } else {
            $transferToOwnerBtn.prop("disabled", false);
            $transferToOwnerBtn.css("opacity", 1);
          }
        } catch (error) {
          console.error("获取所有者信息失败:", error);
          showStatus(
            $ownerInfo,
            `获取所有者信息失败: ${error.message}`,
            "error"
          );
        }
      }

      // 获取合约余额
      async function getContractBalance() {
        if (!contract) {
          showStatus($balanceDisplay, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($balanceDisplay, "正在查询合约余额...", "info");
          const balance = await contract.getBalance();

          const balanceInEth = formatEth(balance);
          $balanceDisplay.html(`
            <div class="balance-display">
              当前合约余额: <span class="amount-highlight"><span class="eth-icon">Ξ</span>${balanceInEth}</span> ETH
            </div>
          `);
        } catch (error) {
          console.error("获取余额失败:", error);
          showStatus(
            $balanceDisplay,
            `获取余额失败: ${error.message}`,
            "error"
          );
        }
      }

      // 存入ETH
      async function depositEth() {
        if (!contract) {
          showStatus($depositStatus, "请先连接钱包", "error");
          return;
        }

        const amount = $depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($depositStatus, "请输入有效的存款金额", "error");
          return;
        }

        try {
          showStatus($depositStatus, `正在存入 ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(
            $depositStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $depositStatus,
            `存款成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          $depositAmount.val("");

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("存款失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足";
          }

          showStatus($depositStatus, `存款失败: ${errorMessage}`, "error");
        }
      }

      // 提取ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus($withdrawStatus, "请先连接钱包", "error");
          return;
        }

        const amount = $withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($withdrawStatus, "请输入有效的提取金额", "error");
          return;
        }

        try {
          showStatus($withdrawStatus, `正在提取 ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(
            $withdrawStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $withdrawStatus,
            `提取成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          $withdrawAmount.val("");

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("提取失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "合约余额不足";
          }

          showStatus($withdrawStatus, `提取失败: ${errorMessage}`, "error");
        }
      }

      // 转移到所有者
      async function transferToOwner() {
        if (!contract) {
          showStatus($transferToOwnerStatus, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($transferToOwnerStatus, "正在转移资金到所有者...", "info");

          const tx = await contract.transferToOwner();

          showStatus(
            $transferToOwnerStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $transferToOwnerStatus,
            `转移成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("转移失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "只有合约所有者才能执行此操作";
          } else if (error.message.includes("No balance")) {
            errorMessage = "合约没有余额可转移";
          }

          showStatus(
            $transferToOwnerStatus,
            `转移失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 监听账户变化
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // 事件监听器
      $(document).ready(function () {
        // 钱包连接
        $connectWalletBtn.on("click", connectWallet);
        $disconnectWalletBtn.on("click", disconnectWallet);

        // 合约切换
        $(".contract-tab").on("click", function () {
          const contractType = $(this).data("contract");
          switchContract(contractType);
        });

        // InfoContract功能
        $sayHiBtn.on("click", callSayHi);
        $setInfoBtn.on("click", setInfo);
        $getInfoBtn.on("click", getInfo);

        // PayableDemo功能
        $getBalanceBtn.on("click", getContractBalance);
        $depositBtn.on("click", depositEth);
        $withdrawBtn.on("click", withdrawEth);
        $transferToOwnerBtn.on("click", transferToOwner);

        // 页面加载完成后检查连接状态
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("检查连接状态失败:", error);
            });
        }
      });
    </script>
  </body>
</html>
