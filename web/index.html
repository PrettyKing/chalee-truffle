<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        /* æ›´æ¸…çˆ½çš„èƒŒæ™¯è‰² - æ›´æ·±çš„çº¯è‰²èƒŒæ™¯ */
        background: #1a1f36;
        min-height: 100vh;
        color: #ffffff;
        overflow-x: hidden;
        position: relative;
      }

      /* æ›´æ¸©å’Œçš„æ¸å˜å åŠ  */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 10% 90%,
            rgba(41, 98, 255, 0.08) 0%,
            transparent 60%
          ),
          radial-gradient(
            circle at 90% 10%,
            rgba(93, 52, 236, 0.08) 0%,
            transparent 60%
          );
        z-index: -1;
        opacity: 0.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
      }

      h1 {
        text-align: center;
        font-size: 2.8rem;
        font-weight: 700;
        margin-bottom: 40px;
        color: #ffffff;
        position: relative;
        padding-bottom: 15px;
      }

      h1::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(101, 120, 248, 0.7),
          transparent
        );
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        background: rgba(35, 41, 70, 0.5);
        border-radius: 12px;
        border: 1px solid rgba(101, 120, 248, 0.2);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      /* æ›´ç®€æ´çš„è¾¹æ¡†æ•ˆæœ */
      .section:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2),
          0 0 15px rgba(101, 120, 248, 0.1);
        border-color: rgba(101, 120, 248, 0.4);
      }

      .section h3 {
        margin-bottom: 20px;
        font-size: 1.4rem;
        color: #6578f8;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* æŒ‰é’®æ ·å¼ */
      button {
        background: #4a56c5;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 8px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(74, 86, 197, 0.3);
        letter-spacing: 0.5px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(74, 86, 197, 0.4);
        background: #5563d6;
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #404868;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.7;
      }

      /* ç‰¹æ®ŠæŒ‰é’®æ ·å¼ */
      #connectWallet {
        background: #3db9ee;
        box-shadow: 0 4px 12px rgba(61, 185, 238, 0.3);
      }

      #connectWallet:hover {
        background: #2eabdf;
        box-shadow: 0 6px 15px rgba(61, 185, 238, 0.4);
      }

      #disconnectWallet {
        background: #e15969;
        box-shadow: 0 4px 12px rgba(225, 89, 105, 0.3);
      }

      #disconnectWallet:hover {
        background: #d44a5a;
        box-shadow: 0 6px 15px rgba(225, 89, 105, 0.4);
      }

      /* è¾“å…¥æ¡†æ ·å¼ */
      input[type="text"],
      input[type="number"] {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(101, 120, 248, 0.2);
        border-radius: 8px;
        padding: 12px 20px;
        color: #ffffff;
        font-size: 14px;
        margin: 8px;
        width: 220px;
        transition: all 0.3s ease;
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: #6578f8;
        box-shadow: 0 0 12px rgba(101, 120, 248, 0.2);
        background: rgba(255, 255, 255, 0.12);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      /* çŠ¶æ€æ¶ˆæ¯æ ·å¼ */
      .status {
        padding: 15px 20px;
        margin: 15px 0;
        border-radius: 8px;
        animation: slideIn 0.3s ease-out;
        position: relative;
        overflow: hidden;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .success {
        background: rgba(38, 187, 99, 0.15);
        border: 1px solid rgba(38, 187, 99, 0.3);
        color: #4eda8c;
      }

      .error {
        background: rgba(225, 89, 105, 0.15);
        border: 1px solid rgba(225, 89, 105, 0.3);
        color: #f38a96;
      }

      .info {
        background: rgba(61, 185, 238, 0.15);
        border: 1px solid rgba(61, 185, 238, 0.3);
        color: #72d3ff;
      }

      .hidden {
        display: none;
      }

      #accountInfo {
        font-weight: 500;
        color: #4eda8c;
        font-size: 1rem;
        padding: 12px 15px;
        background: rgba(38, 187, 99, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(38, 187, 99, 0.2);
        margin: 10px 0;
        display: inline-block;
      }

      /* åŠ è½½åŠ¨ç”» */
      .loading {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top-color: #6578f8;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 2rem;
        }

        .section {
          padding: 20px;
        }

        input[type="text"],
        input[type="number"] {
          width: 100%;
          margin: 5px 0;
        }

        button {
          width: 100%;
          margin: 5px 0;
        }
      }

      /* ä½™é¢æ˜¾ç¤ºæ ·å¼ */
      .balance-display {
        background: rgba(255, 201, 71, 0.15);
        border: 1px solid rgba(255, 201, 71, 0.3);
        color: #ffd866;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin: 15px 0;
        font-size: 1.2rem;
        font-weight: 500;
      }

      /* é‡‘é¢é«˜äº®æ ·å¼ */
      .amount-highlight {
        color: #ffd866;
        font-weight: bold;
      }

      /* ETHå›¾æ ‡ */
      .eth-icon {
        font-size: 1.2em;
        margin-right: 5px;
      }

      /* æ‰€æœ‰è€…ä¿¡æ¯æ ·å¼ */
      .owner-info {
        background: rgba(101, 120, 248, 0.1);
        border: 1px solid rgba(101, 120, 248, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .owner-address {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .owner-badge {
        background: linear-gradient(45deg, #ffd866, #ffb347);
        color: #333;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      /* è½¬ç§»åˆ°æ‰€æœ‰è€…æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
      #transferToOwnerBtn {
        background: linear-gradient(45deg, #ffd866, #ffb347);
        color: #333;
        box-shadow: 0 4px 12px rgba(255, 201, 71, 0.3);
        font-weight: 600;
      }

      #transferToOwnerBtn:hover {
        box-shadow: 0 6px 15px rgba(255, 201, 71, 0.4);
        background: linear-gradient(45deg, #ffb347, #ffd866);
      }

      /* é¡µé¢åº•éƒ¨ç©ºé—´ */
      .page-bottom-space {
        height: 50px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Chalee DApp</h1>

      <!-- é’±åŒ…è¿æ¥éƒ¨åˆ† -->
      <div class="section">
        <h3>ğŸ”— é’±åŒ…è¿æ¥</h3>
        <button id="connectWallet">è¿æ¥ MetaMask</button>
        <button id="disconnectWallet" class="hidden">æ–­å¼€è¿æ¥</button>
        <div id="accountInfo" class="hidden"></div>
        <div id="connectionStatus"></div>
        <!-- åˆçº¦æ‰€æœ‰è€… -->
        <div id="ownerInfo"></div>

        <!-- åˆçº¦ä½™é¢ -->
        <div id="balanceDisplay"></div>
      </div>

      <!-- sayHi æµ‹è¯• -->
      <div class="section">
        <h3>ğŸ‘‹ Say Hi æµ‹è¯•</h3>
        <button id="sayHiBtn">è°ƒç”¨ sayHi()</button>
        <div id="sayHiResult"></div>
      </div>

      <!-- è®¾ç½®ä¿¡æ¯ -->
      <div class="section">
        <h3>ğŸ“ è®¾ç½®ä¿¡æ¯</h3>
        <div>
          <input type="text" id="nameInput" placeholder="è¾“å…¥å§“å" />
          <input type="number" id="ageInput" placeholder="è¾“å…¥å¹´é¾„" />
          <button id="setInfoBtn">è®¾ç½®ä¿¡æ¯</button>
        </div>
        <div id="setInfoStatus"></div>
      </div>

      <!-- è·å–ä¿¡æ¯ -->
      <div class="section">
        <h3>ğŸ“‹ è·å–ä¿¡æ¯</h3>
        <button id="getInfoBtn">è·å–å½“å‰ä¿¡æ¯</button>
        <div id="getInfoResult"></div>
      </div>

      <!-- å­˜æ¬¾åŠŸèƒ½ -->
      <div class="section">
        <h3>ğŸ“¥ å­˜å…¥ETH</h3>
        <div>
          <input
            type="number"
            id="depositAmount"
            placeholder="è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆETHï¼‰"
            step="0.001"
            min="0.001"
          />
          <button id="depositBtn">å­˜å…¥</button>
        </div>
        <div id="depositStatus"></div>
      </div>

      <!-- ææ¬¾åŠŸèƒ½ -->
      <div class="section">
        <h3>ğŸ“¤ æå–ETH</h3>
        <div>
          <input
            type="number"
            id="withdrawAmount"
            placeholder="è¾“å…¥æå–é‡‘é¢ï¼ˆETHï¼‰"
            step="0.001"
            min="0.001"
          />
          <button id="withdrawBtn">æå–</button>
        </div>
        <div id="withdrawStatus"></div>
      </div>

      <!-- è½¬ç§»åˆ°æ‰€æœ‰è€…åŠŸèƒ½ -->
      <div class="section">
        <h3>ğŸ† è½¬ç§»åˆ°æ‰€æœ‰è€…</h3>
        <div>
          <button id="transferToOwnerBtn">è½¬ç§»æ‰€æœ‰ä½™é¢åˆ°åˆçº¦æ‰€æœ‰è€…</button>
          <div id="transferToOwnerStatus"></div>
        </div>
      </div>

      <div class="page-bottom-space"></div>
    </div>

    <script>
      // åˆçº¦é…ç½® - ä½¿ç”¨åˆå¹¶åçš„åˆçº¦
      const CONTRACT_ADDRESS = "0xa14f1Fded1d7Eec3d94E7069aA02D924D1db8860"; // éƒ¨ç½²åéœ€è¦æ›´æ–°ä¸ºå®é™…åœ°å€
      const CONTRACT_ABI = [
        {
          inputs: [],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "sender",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Deposit",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "string",
              name: "name",
              type: "string",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "age",
              type: "uint256",
            },
          ],
          name: "Instructor",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "receiver",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Withdraw",
          type: "event",
        },
        {
          inputs: [],
          name: "balance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getInfo",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [
            {
              internalType: "address",
              name: "",
              type: "address",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "sayHi",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
          ],
          stateMutability: "pure",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "_name",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "_age",
              type: "uint256",
            },
          ],
          name: "setInfo",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "transferToOwner",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "withdraw",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      // å…¨å±€å˜é‡
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;
      let infoEventListener = null;
      let depositEventListener = null;
      let withdrawEventListener = null;
      let activeContract = "infoContract";

      // DOM å…ƒç´ 
      const $connectWalletBtn = $("#connectWallet");
      const $disconnectWalletBtn = $("#disconnectWallet");
      const $accountInfo = $("#accountInfo");
      const $connectionStatus = $("#connectionStatus");
      const $contractTabs = $("#contractTabs");
      const $connectionIndicator = $("#connectionIndicator");

      // DOMå…ƒç´ 
      const $infoContractSection = $("#infoContractSection");
      const $sayHiBtn = $("#sayHiBtn");
      const $sayHiResult = $("#sayHiResult");
      const $setInfoBtn = $("#setInfoBtn");
      const $nameInput = $("#nameInput");
      const $ageInput = $("#ageInput");
      const $setInfoStatus = $("#setInfoStatus");
      const $getInfoBtn = $("#getInfoBtn");
      const $getInfoResult = $("#getInfoResult");
      const $eventLog = $("#eventLog");
      const $payableDemoSection = $("#payableDemoSection");
      const $ownerInfo = $("#ownerInfo");
      const $balanceDisplay = $("#balanceDisplay");
      const $depositAmount = $("#depositAmount");
      const $depositBtn = $("#depositBtn");
      const $depositStatus = $("#depositStatus");
      const $withdrawAmount = $("#withdrawAmount");
      const $withdrawBtn = $("#withdrawBtn");
      const $withdrawStatus = $("#withdrawStatus");
      const $transferToOwnerBtn = $("#transferToOwnerBtn");
      const $transferToOwnerStatus = $("#transferToOwnerStatus");

      // å·¥å…·å‡½æ•°
      function showStatus($element, message, type = "info") {
        const loadingSpinner =
          type === "info" && message.includes("æ­£åœ¨")
            ? '<div class="loading"></div>'
            : "";
        $element.html(
          `<div class="status ${type}">${loadingSpinner}${message}</div>`
        );
      }

      function clearStatus($element) {
        $element.html("");
      }

      // æ›´æ–°è¿æ¥æŒ‡ç¤ºå™¨
      function updateConnectionIndicator(connected) {
        if (connected) {
          if ($connectionIndicator) $connectionIndicator.addClass("connected");
        } else {
          if ($connectionIndicator)
            $connectionIndicator.removeClass("connected");
        }
      }

      // æ£€æŸ¥æ˜¯å¦å®‰è£…äº† MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask å·²å®‰è£…");
          return true;
        } else {
          showStatus($connectionStatus, "è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•ï¼", "error");
          return false;
        }
      }

      // è¿æ¥é’±åŒ…
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus($connectionStatus, "æ­£åœ¨è¿æ¥é’±åŒ…...", "info");

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          // åˆå§‹åŒ–åˆçº¦
          contract = new ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            signer
          );

          updateConnectionUI(true);
          updateConnectionIndicator(true);
          showStatus($connectionStatus, "é’±åŒ…è¿æ¥æˆåŠŸï¼", "success");

          // è·å–åˆçº¦æ‰€æœ‰è€…ä¿¡æ¯
          getOwnerInfo();
          // è·å–åˆçº¦ä½™é¢
          getContractBalance();
        } catch (error) {
          console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
          showStatus($connectionStatus, `è¿æ¥å¤±è´¥: ${error.message}`, "error");
          updateConnectionIndicator(false);
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        // åœæ­¢æ‰€æœ‰äº‹ä»¶ç›‘å¬
        stopAllEventListeners();

        updateConnectionUI(false);
        updateConnectionIndicator(false);
        showStatus($connectionStatus, "å·²æ–­å¼€é’±åŒ…è¿æ¥", "info");
        clearAllResults();
      }

      // åœæ­¢æ‰€æœ‰äº‹ä»¶ç›‘å¬
      function stopAllEventListeners() {
        if (contract) {
          if (infoEventListener) {
            contract.off("Instructor", infoEventListener);
            infoEventListener = null;
          }

          if (depositEventListener) {
            contract.off("Deposit", depositEventListener);
            depositEventListener = null;
          }

          if (withdrawEventListener) {
            contract.off("Withdraw", withdrawEventListener);
            withdrawEventListener = null;
          }
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€ UI
      function updateConnectionUI(connected) {
        if (connected) {
          $connectWalletBtn.addClass("hidden");
          $disconnectWalletBtn.removeClass("hidden");
          $accountInfo.removeClass("hidden");
          if ($contractTabs) $contractTabs.removeClass("hidden");
          $accountInfo.text(
            `å·²è¿æ¥è´¦æˆ·: ${currentAccount.slice(0, 6)}...${currentAccount.slice(
              -4
            )}`
          );
          if ($infoContractSection) $infoContractSection.removeClass("hidden");
        } else {
          $connectWalletBtn.removeClass("hidden");
          $disconnectWalletBtn.addClass("hidden");
          $accountInfo.addClass("hidden");
          if ($contractTabs) $contractTabs.addClass("hidden");
          if ($infoContractSection) $infoContractSection.addClass("hidden");
          if ($payableDemoSection) $payableDemoSection.addClass("hidden");
        }
      }

      // æ¸…é™¤æ‰€æœ‰ç»“æœ
      function clearAllResults() {
        // æ¸…é™¤InfoContractç›¸å…³çŠ¶æ€
        clearStatus($sayHiResult);
        clearStatus($setInfoStatus);
        clearStatus($getInfoResult);
        if ($eventLog) clearStatus($eventLog);

        // æ¸…é™¤PayableDemoç›¸å…³çŠ¶æ€
        clearStatus($ownerInfo);
        clearStatus($balanceDisplay);
        clearStatus($depositStatus);
        clearStatus($withdrawStatus);
        clearStatus($transferToOwnerStatus);
      }

      // åˆ‡æ¢åˆçº¦è§†å›¾
      function switchContract(contractType) {
        activeContract = contractType;

        if (contractType === "infoContract") {
          $infoContractSection.removeClass("hidden");
          $payableDemoSection.addClass("hidden");
          $('.contract-tab[data-contract="infoContract"]').addClass("active");
          $('.contract-tab[data-contract="payableDemo"]').removeClass("active");
        } else {
          $infoContractSection.addClass("hidden");
          $payableDemoSection.removeClass("hidden");
          $('.contract-tab[data-contract="infoContract"]').removeClass(
            "active"
          );
          $('.contract-tab[data-contract="payableDemo"]').addClass("active");

          // åˆ·æ–°ä½™é¢å’Œæ‰€æœ‰è€…ä¿¡æ¯
          getOwnerInfo();
          getContractBalance();
        }
      }

      //===== InfoContract åŠŸèƒ½ =====//

      // sayHi å‡½æ•°
      async function callSayHi() {
        if (!contract) {
          showStatus($sayHiResult, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus($sayHiResult, "æ­£åœ¨è°ƒç”¨ sayHi()...", "info");
          const result = await contract.sayHi();
          showStatus($sayHiResult, `sayHi() è¿”å›: "${result}"`, "success");
        } catch (error) {
          console.error("è°ƒç”¨ sayHi å¤±è´¥:", error);
          showStatus($sayHiResult, `è°ƒç”¨å¤±è´¥: ${error.message}`, "error");
        }
      }

      // è®¾ç½®ä¿¡æ¯
      async function setInfo() {
        if (!contract) {
          showStatus($setInfoStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const name = $nameInput.val().trim();
        const age = parseInt($ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus($setInfoStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å§“åå’Œå¹´é¾„", "error");
          return;
        }

        try {
          showStatus($setInfoStatus, "æ­£åœ¨è®¾ç½®ä¿¡æ¯...", "info");

          const tx = await contract.setInfo(name, age);
          showStatus(
            $setInfoStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $setInfoStatus,
            `è®¾ç½®æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          $nameInput.val("");
          $ageInput.val("");
        } catch (error) {
          console.error("è®¾ç½®ä¿¡æ¯å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³";
          }

          showStatus($setInfoStatus, `è®¾ç½®å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // è·å–ä¿¡æ¯
      async function getInfo() {
        if (!contract) {
          showStatus($getInfoResult, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus($getInfoResult, "æ­£åœ¨è·å–ä¿¡æ¯...", "info");
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(
              $getInfoResult,
              `å½“å‰ä¿¡æ¯ - å§“å: "${name}", å¹´é¾„: ${age.toString()}`,
              "success"
            );
          } else {
            showStatus($getInfoResult, "æš‚æ— ä¿¡æ¯æˆ–ä¿¡æ¯ä¸ºç©º", "info");
          }
        } catch (error) {
          console.error("è·å–ä¿¡æ¯å¤±è´¥:", error);
          showStatus($getInfoResult, `è·å–å¤±è´¥: ${error.message}`, "error");
        }
      }

      //===== PayableDemo åŠŸèƒ½ =====//

      // æ ¼å¼åŒ–ETHé‡‘é¢
      function formatEth(wei) {
        return ethers.formatEther(wei);
      }

      // è§£æETHé‡‘é¢ä¸ºwei
      function parseEth(eth) {
        return ethers.parseEther(eth.toString());
      }

      // è·å–åˆçº¦æ‰€æœ‰è€…ä¿¡æ¯
      async function getOwnerInfo() {
        if (!contract) {
          showStatus($ownerInfo, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          const owner = await contract.owner();

          const isCurrentUserOwner =
            owner.toLowerCase() === currentAccount.toLowerCase();
          const ownerDisplay = `
                        <div class="owner-info">
                          <div class="owner-address">
                            åˆçº¦æ‰€æœ‰è€…: ${owner.slice(0, 8)}...${owner.slice(-6)}
                            ${
                              isCurrentUserOwner
                                ? '<span class="owner-badge">æ‚¨æ˜¯æ‰€æœ‰è€…</span>'
                                : ""
                            }
                          </div>
                          <div>
                ${
                  isCurrentUserOwner
                    ? '<div style="color: #ffd866; font-size: 0.85rem;">æ‚¨å¯ä»¥æ‰§è¡Œæ‰€æœ‰è€…ç‰¹æƒæ“ä½œ</div>'
                    : '<div style="color: #f38a96; font-size: 0.85rem;">æ‚¨ä¸æ˜¯åˆçº¦æ‰€æœ‰è€…</div>'
                }
              </div>
            </div>
          `;

          $ownerInfo.html(ownerDisplay);

          // å¦‚æœå½“å‰ç”¨æˆ·ä¸æ˜¯æ‰€æœ‰è€…ï¼Œç¦ç”¨è½¬ç§»åˆ°æ‰€æœ‰è€…æŒ‰é’®
          if (!isCurrentUserOwner) {
            $transferToOwnerBtn.prop("disabled", true);
            $transferToOwnerBtn.css("opacity", 0.5);
          } else {
            $transferToOwnerBtn.prop("disabled", false);
            $transferToOwnerBtn.css("opacity", 1);
          }
        } catch (error) {
          console.error("è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥:", error);
          showStatus(
            $ownerInfo,
            `è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥: ${error.message}`,
            "error"
          );
        }
      }

      // è·å–åˆçº¦ä½™é¢
      async function getContractBalance() {
        if (!contract) {
          showStatus($balanceDisplay, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus($balanceDisplay, "æ­£åœ¨æŸ¥è¯¢åˆçº¦ä½™é¢...", "info");
          const balance = await contract.getBalance();

          const balanceInEth = formatEth(balance);
          $balanceDisplay.html(`
            <div class="balance-display">
              å½“å‰åˆçº¦ä½™é¢: <span class="amount-highlight"><span class="eth-icon">Î</span>${balanceInEth}</span> ETH
            </div>
          `);
        } catch (error) {
          console.error("è·å–ä½™é¢å¤±è´¥:", error);
          showStatus(
            $balanceDisplay,
            `è·å–ä½™é¢å¤±è´¥: ${error.message}`,
            "error"
          );
        }
      }

      // å­˜å…¥ETH
      async function depositEth() {
        if (!contract) {
          showStatus($depositStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = $depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($depositStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢", "error");
          return;
        }

        try {
          showStatus($depositStatus, `æ­£åœ¨å­˜å…¥ ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(
            $depositStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $depositStatus,
            `å­˜æ¬¾æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          $depositAmount.val("");

          // åˆ·æ–°ä½™é¢
          getContractBalance();
        } catch (error) {
          console.error("å­˜æ¬¾å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³";
          }

          showStatus($depositStatus, `å­˜æ¬¾å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // æå–ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus($withdrawStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = $withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($withdrawStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„æå–é‡‘é¢", "error");
          return;
        }

        try {
          showStatus($withdrawStatus, `æ­£åœ¨æå– ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(
            $withdrawStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $withdrawStatus,
            `æå–æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          $withdrawAmount.val("");

          // åˆ·æ–°ä½™é¢
          getContractBalance();
        } catch (error) {
          console.error("æå–å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "åˆçº¦ä½™é¢ä¸è¶³";
          }

          showStatus($withdrawStatus, `æå–å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // è½¬ç§»åˆ°æ‰€æœ‰è€…
      async function transferToOwner() {
        if (!contract) {
          showStatus($transferToOwnerStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus($transferToOwnerStatus, "æ­£åœ¨è½¬ç§»èµ„é‡‘åˆ°æ‰€æœ‰è€…...", "info");

          const tx = await contract.transferToOwner();

          showStatus(
            $transferToOwnerStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $transferToOwnerStatus,
            `è½¬ç§»æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          // åˆ·æ–°ä½™é¢
          getContractBalance();
        } catch (error) {
          console.error("è½¬ç§»å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "åªæœ‰åˆçº¦æ‰€æœ‰è€…æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ";
          } else if (error.message.includes("No balance")) {
            errorMessage = "åˆçº¦æ²¡æœ‰ä½™é¢å¯è½¬ç§»";
          }

          showStatus(
            $transferToOwnerStatus,
            `è½¬ç§»å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // ç›‘å¬è´¦æˆ·å˜åŒ–
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // äº‹ä»¶ç›‘å¬å™¨
      $(document).ready(function () {
        // é’±åŒ…è¿æ¥
        $connectWalletBtn.on("click", connectWallet);
        $disconnectWalletBtn.on("click", disconnectWallet);

        // åˆçº¦åˆ‡æ¢
        $(".contract-tab").on("click", function () {
          const contractType = $(this).data("contract");
          switchContract(contractType);
        });

        // InfoContractåŠŸèƒ½
        $sayHiBtn.on("click", callSayHi);
        $setInfoBtn.on("click", setInfo);
        $getInfoBtn.on("click", getInfo);

        // PayableDemoåŠŸèƒ½
        $depositBtn.on("click", depositEth);
        $withdrawBtn.on("click", withdrawEth);
        $transferToOwnerBtn.on("click", transferToOwner);

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥è¿æ¥çŠ¶æ€
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥:", error);
            });
        }
      });
    </script>
  </body>
</html>
