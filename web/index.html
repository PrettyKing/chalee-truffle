<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp - Enhanced</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #ffffff;
        overflow-x: hidden;
        position: relative;
      }

      /* åŠ¨ç”»èƒŒæ™¯ç²’å­æ•ˆæœ */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
        animation: float 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes float {
        0%, 100% { opacity: 0.3; transform: translateY(0px); }
        50% { opacity: 0.8; transform: translateY(-20px); }
      }

      /* ç»ç’ƒæ€æ•ˆæœ */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
      }

      /* å¤´éƒ¨å¢å¼º */
      .header {
        text-align: center;
        margin-bottom: 50px;
        padding: 30px 0;
      }

      h1 {
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        letter-spacing: -0.02em;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 300;
        margin-bottom: 30px;
      }

      /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
      .connection-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 0.95rem;
        margin-bottom: 20px;
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ff6b6b;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #51cf66;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      /* åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .card {
        padding: 30px;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .card h3 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }

      .card-icon {
        font-size: 1.8rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      /* è¾“å…¥æ§ä»¶å¢å¼º */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      .input-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      input[type="text"],
      input[type="number"] {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px 20px;
        color: #ffffff;
        font-size: 1rem;
        flex: 1;
        min-width: 200px;
        transition: all 0.3s ease;
        font-weight: 400;
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.6);
        font-weight: 300;
      }

      /* æŒ‰é’®ç³»ç»Ÿå‡çº§ */
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        letter-spacing: 0.5px;
        min-width: 140px;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        filter: brightness(1.1);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.6;
      }

      /* ä¸“ç”¨æŒ‰é’®æ ·å¼ */
      .btn-primary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
      }

      .btn-primary:hover {
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .btn-danger:hover {
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
      }

      .btn-success {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        box-shadow: 0 4px 15px rgba(81, 207, 102, 0.4);
      }

      .btn-success:hover {
        box-shadow: 0 8px 25px rgba(81, 207, 102, 0.6);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
        color: #333;
        box-shadow: 0 4px 15px rgba(255, 212, 59, 0.4);
      }

      .btn-warning:hover {
        box-shadow: 0 8px 25px rgba(255, 212, 59, 0.6);
      }

      /* çŠ¶æ€æ¶ˆæ¯å¢å¼º */
      .status-message {
        padding: 18px 24px;
        margin: 20px 0;
        border-radius: 12px;
        border-left: 4px solid;
        animation: slideInUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-success {
        background: rgba(81, 207, 102, 0.15);
        border-left-color: #51cf66;
        color: #d3f9d8;
      }

      .status-error {
        background: rgba(255, 107, 107, 0.15);
        border-left-color: #ff6b6b;
        color: #ffe0e0;
      }

      .status-info {
        background: rgba(79, 172, 254, 0.15);
        border-left-color: #4facfe;
        color: #d0ebff;
      }

      .status-warning {
        background: rgba(255, 212, 59, 0.15);
        border-left-color: #ffd43b;
        color: #fff3bf;
      }

      /* è´¦æˆ·ä¿¡æ¯æ ·å¼ */
      .account-info {
        background: rgba(81, 207, 102, 0.1);
        border: 2px solid rgba(81, 207, 102, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
        font-weight: 500;
        backdrop-filter: blur(10px);
      }

      .account-address {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.9rem;
        word-break: break-all;
        margin-top: 8px;
        opacity: 0.9;
      }

      /* ä½™é¢æ˜¾ç¤ºå¢å¼º */
      .balance-display {
        background: linear-gradient(135deg, rgba(255, 212, 59, 0.2) 0%, rgba(250, 176, 5, 0.2) 100%);
        border: 2px solid rgba(255, 212, 59, 0.4);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .balance-amount {
        font-size: 2rem;
        font-weight: 700;
        color: #ffd43b;
        text-shadow: 0 2px 10px rgba(255, 212, 59, 0.3);
        margin-bottom: 8px;
      }

      .balance-label {
        font-size: 1rem;
        opacity: 0.8;
        font-weight: 400;
      }

      /* æ‰€æœ‰è€…ä¿¡æ¯ */
      .owner-info {
        background: linear-gradient(135deg, rgba(118, 75, 162, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
        border: 2px solid rgba(118, 75, 162, 0.4);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .owner-badge {
        display: inline-block;
        background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(255, 212, 59, 0.3);
      }

      /* åŠ è½½åŠ¨ç”»å¢å¼º */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 1s linear infinite;
        margin-right: 12px;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* å“åº”å¼è®¾è®¡å¢å¼º */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 2.5rem;
        }

        .grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .card {
          padding: 25px;
        }

        .input-row {
          flex-direction: column;
        }

        input[type="text"],
        input[type="number"] {
          min-width: unset;
        }

        .btn {
          width: 100%;
          margin: 5px 0;
        }
      }

      /* éšè—ç±» */
      .hidden {
        display: none !important;
      }

      /* å·¥å…·æç¤º */
      .tooltip {
        position: relative;
        cursor: help;
      }

      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
      }

      .tooltip:hover::after {
        opacity: 1;
      }

      /* é¡µé¢åº•éƒ¨ç©ºé—´ */
      .footer-space {
        height: 60px;
      }

      /* å¢å¼ºçš„å¡ç‰‡åŠ¨ç”» */
      .card {
        animation: cardFade 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
      }

      .card:nth-child(1) { animation-delay: 0.1s; }
      .card:nth-child(2) { animation-delay: 0.2s; }
      .card:nth-child(3) { animation-delay: 0.3s; }
      .card:nth-child(4) { animation-delay: 0.4s; }
      .card:nth-child(5) { animation-delay: 0.5s; }

      @keyframes cardFade {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- å¢å¼ºçš„å¤´éƒ¨ -->
      <div class="header">
        <h1>Chalee DApp</h1>
        <p class="subtitle">ç°ä»£åŒ–çš„ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦äº¤äº’å¹³å°</p>
      </div>

      <!-- é’±åŒ…è¿æ¥å¡ç‰‡ -->
      <div class="card glass" style="margin-bottom: 20px;">
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="connectionText">æœªè¿æ¥</span>
        </div>
        <h3><span class="card-icon">ğŸ”—</span>é’±åŒ…è¿æ¥</h3>
        <div class="input-group">
          <div class="input-row">
            <button id="connectWallet" class="btn btn-primary">è¿æ¥ MetaMask</button>
            <button id="disconnectWallet" class="btn btn-danger hidden">æ–­å¼€è¿æ¥</button>
          </div>
        </div>
        <div id="accountInfo" class="account-info hidden"></div>
        <div id="connectionStatus"></div>
        <div id="ownerInfo"></div>
        <div id="balanceDisplay"></div>
      </div>

      <!-- åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ -->
      <div class="grid">
        <!-- ä¿¡æ¯ç®¡ç†å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“</span>ä¿¡æ¯ç®¡ç†</h3>
          <div class="input-group">
            <div class="input-row">
              <input type="text" id="nameInput" placeholder="è¾“å…¥å§“å" />
              <input type="number" id="ageInput" placeholder="è¾“å…¥å¹´é¾„" />
            </div>
            <button id="setInfoBtn" class="btn">è®¾ç½®ä¿¡æ¯</button>
          </div>
          <div id="setInfoStatus"></div>
          
          <div class="input-group" style="margin-top: 25px;">
            <button id="getInfoBtn" class="btn btn-success">è·å–å½“å‰ä¿¡æ¯</button>
          </div>
          <div id="getInfoResult"></div>
        </div>

        <!-- å­˜æ¬¾åŠŸèƒ½å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“¥</span>å­˜å…¥ ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="depositAmount"
              placeholder="è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆETHï¼‰"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="æœ€å°å­˜æ¬¾é‡‘é¢ä¸º 0.001 ETH"
            />
            <button id="depositBtn" class="btn btn-success">å­˜å…¥</button>
          </div>
          <div id="depositStatus"></div>
        </div>

        <!-- ææ¬¾åŠŸèƒ½å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“¤</span>æå– ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="withdrawAmount"
              placeholder="è¾“å…¥æå–é‡‘é¢ï¼ˆETHï¼‰"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="ç¡®ä¿åˆçº¦æœ‰è¶³å¤Ÿä½™é¢"
            />
            <button id="withdrawBtn" class="btn btn-primary">æå–</button>
          </div>
          <div id="withdrawStatus"></div>
        </div>

        <!-- æ‰€æœ‰è€…æ“ä½œå¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ†</span>æ‰€æœ‰è€…æ“ä½œ</h3>
          <div class="input-group">
            <button id="transferToOwnerBtn" class="btn btn-warning tooltip" data-tooltip="åªæœ‰åˆçº¦æ‰€æœ‰è€…å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ">
              è½¬ç§»æ‰€æœ‰ä½™é¢åˆ°åˆçº¦æ‰€æœ‰è€…
            </button>
          </div>
          <div id="transferToOwnerStatus"></div>
        </div>
      </div>

      <div class="footer-space"></div>
    </div>

    <script>
      // åˆçº¦é…ç½®
      const CONTRACT_ADDRESS = "0xa14f1Fded1d7Eec3d94E7069aA02D924D1db8860";
      const CONTRACT_ABI = [
        {
          inputs: [],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "sender",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Deposit",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "string",
              name: "name",
              type: "string",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "age",
              type: "uint256",
            },
          ],
          name: "Instructor",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "receiver",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Withdraw",
          type: "event",
        },
        {
          inputs: [],
          name: "balance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getInfo",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [
            {
              internalType: "address",
              name: "",
              type: "address",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "sayHi",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
          ],
          stateMutability: "pure",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "_name",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "_age",
              type: "uint256",
            },
          ],
          name: "setInfo",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "transferToOwner",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "withdraw",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      // å…¨å±€å˜é‡
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;

      // DOM å…ƒç´ 
      const elements = {
        connectWallet: $("#connectWallet"),
        disconnectWallet: $("#disconnectWallet"),
        accountInfo: $("#accountInfo"),
        connectionStatus: $("#connectionStatus"),
        statusDot: $("#statusDot"),
        connectionText: $("#connectionText"),
        ownerInfo: $("#ownerInfo"),
        balanceDisplay: $("#balanceDisplay"),
        
        // ä¿¡æ¯ç®¡ç†
        nameInput: $("#nameInput"),
        ageInput: $("#ageInput"),
        setInfoBtn: $("#setInfoBtn"),
        setInfoStatus: $("#setInfoStatus"),
        getInfoBtn: $("#getInfoBtn"),
        getInfoResult: $("#getInfoResult"),
        
        // å­˜æ¬¾
        depositAmount: $("#depositAmount"),
        depositBtn: $("#depositBtn"),
        depositStatus: $("#depositStatus"),
        
        // ææ¬¾
        withdrawAmount: $("#withdrawAmount"),
        withdrawBtn: $("#withdrawBtn"),
        withdrawStatus: $("#withdrawStatus"),
        
        // æ‰€æœ‰è€…æ“ä½œ
        transferToOwnerBtn: $("#transferToOwnerBtn"),
        transferToOwnerStatus: $("#transferToOwnerStatus")
      };

      // å·¥å…·å‡½æ•°
      function showStatus(element, message, type = "info", showLoading = false) {
        const loadingSpinner = showLoading ? '<div class="loading-spinner"></div>' : '';
        const statusClass = `status-${type}`;
        element.html(`<div class="status-message ${statusClass}">${loadingSpinner}${message}</div>`);
      }

      function clearStatus(element) {
        element.html("");
      }

      function updateConnectionStatus(connected, account = null) {
        const dot = elements.statusDot;
        const text = elements.connectionText;
        
        if (connected) {
          dot.addClass("connected");
          text.text("å·²è¿æ¥");
          if (account) {
            const shortAccount = `${account.slice(0, 6)}...${account.slice(-4)}`;
            elements.accountInfo.html(`
              <div class="account-address">å½“å‰è´¦æˆ·: ${shortAccount}</div>
              <div class="account-address">${account}</div>
            `).removeClass("hidden");
          }
        } else {
          dot.removeClass("connected");
          text.text("æœªè¿æ¥");
          elements.accountInfo.addClass("hidden");
        }
      }

      function formatEth(wei) {
        return ethers.formatEther(wei);
      }

      function parseEth(eth) {
        return ethers.parseEther(eth.toString());
      }

      // æ£€æŸ¥ MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask å·²å®‰è£…");
          return true;
        } else {
          showStatus(elements.connectionStatus, "è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•ï¼", "error");
          return false;
        }
      }

      // è¿æ¥é’±åŒ…
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus(elements.connectionStatus, "æ­£åœ¨è¿æ¥é’±åŒ…...", "info", true);

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          updateConnectionUI(true);
          updateConnectionStatus(true, currentAccount);
          showStatus(elements.connectionStatus, "é’±åŒ…è¿æ¥æˆåŠŸï¼", "success");

          // è·å–åˆçº¦ä¿¡æ¯
          await Promise.all([
            getOwnerInfo(),
            getContractBalance()
          ]);

        } catch (error) {
          console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
          showStatus(elements.connectionStatus, `è¿æ¥å¤±è´¥: ${error.message}`, "error");
          updateConnectionStatus(false);
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        updateConnectionUI(false);
        updateConnectionStatus(false);
        showStatus(elements.connectionStatus, "å·²æ–­å¼€é’±åŒ…è¿æ¥", "info");
        clearAllResults();
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€ UI
      function updateConnectionUI(connected) {
        if (connected) {
          elements.connectWallet.addClass("hidden");
          elements.disconnectWallet.removeClass("hidden");
        } else {
          elements.connectWallet.removeClass("hidden");
          elements.disconnectWallet.addClass("hidden");
        }
      }

      // æ¸…é™¤æ‰€æœ‰ç»“æœ
      function clearAllResults() {
        [
          elements.setInfoStatus,
          elements.getInfoResult,
          elements.ownerInfo,
          elements.balanceDisplay,
          elements.depositStatus,
          elements.withdrawStatus,
          elements.transferToOwnerStatus
        ].forEach(clearStatus);
      }

      // è·å–åˆçº¦æ‰€æœ‰è€…ä¿¡æ¯
      async function getOwnerInfo() {
        if (!contract) return;

        try {
          const owner = await contract.owner();
          const isCurrentUserOwner = owner.toLowerCase() === currentAccount.toLowerCase();
          
          const ownerDisplay = `
            <div class="owner-info">
              ${isCurrentUserOwner ? '<div class="owner-badge">æ‚¨æ˜¯åˆçº¦æ‰€æœ‰è€…</div>' : ''}
              <div style="font-size: 0.9rem; opacity: 0.9;">
                ${isCurrentUserOwner 
                  ? 'æ‚¨æ‹¥æœ‰åˆçº¦çš„å®Œå…¨æ§åˆ¶æƒ' 
                  : 'æ‚¨ä¸æ˜¯åˆçº¦æ‰€æœ‰è€…ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™'
                }
              </div>
            </div>
          `;

          elements.ownerInfo.html(ownerDisplay);

          // æ§åˆ¶æ‰€æœ‰è€…æŒ‰é’®çŠ¶æ€
          elements.transferToOwnerBtn.prop("disabled", !isCurrentUserOwner);
          if (!isCurrentUserOwner) {
            elements.transferToOwnerBtn.css("opacity", 0.5);
          } else {
            elements.transferToOwnerBtn.css("opacity", 1);
          }

        } catch (error) {
          console.error("è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥:", error);
          showStatus(elements.ownerInfo, `è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥: ${error.message}`, "error");
        }
      }

      // è·å–åˆçº¦ä½™é¢
      async function getContractBalance() {
        if (!contract) return;

        try {
          const balance = await contract.getBalance();
          const balanceInEth = formatEth(balance);
          
          elements.balanceDisplay.html(`
            <div class="balance-display">
              <div class="balance-amount">Î ${balanceInEth}</div>
              <div class="balance-label">åˆçº¦å½“å‰ä½™é¢</div>
            </div>
          `);
        } catch (error) {
          console.error("è·å–ä½™é¢å¤±è´¥:", error);
          showStatus(elements.balanceDisplay, `è·å–ä½™é¢å¤±è´¥: ${error.message}`, "error");
        }
      }

      // è®¾ç½®ä¿¡æ¯
      async function setInfo() {
        if (!contract) {
          showStatus(elements.setInfoStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const name = elements.nameInput.val().trim();
        const age = parseInt(elements.ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus(elements.setInfoStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å§“åå’Œå¹´é¾„", "error");
          return;
        }

        try {
          showStatus(elements.setInfoStatus, "æ­£åœ¨è®¾ç½®ä¿¡æ¯...", "info", true);

          const tx = await contract.setInfo(name, age);
          showStatus(elements.setInfoStatus, `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.setInfoStatus, `è®¾ç½®æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`, "success");

          elements.nameInput.val("");
          elements.ageInput.val("");

        } catch (error) {
          console.error("è®¾ç½®ä¿¡æ¯å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨";
          }

          showStatus(elements.setInfoStatus, `è®¾ç½®å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // è·å–ä¿¡æ¯
      async function getInfo() {
        if (!contract) {
          showStatus(elements.getInfoResult, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus(elements.getInfoResult, "æ­£åœ¨è·å–ä¿¡æ¯...", "info", true);
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(elements.getInfoResult, `å½“å‰ä¿¡æ¯ - å§“å: "${name}", å¹´é¾„: ${age.toString()}`, "success");
          } else {
            showStatus(elements.getInfoResult, "æš‚æ— ä¿¡æ¯æˆ–ä¿¡æ¯ä¸ºç©º", "warning");
          }
        } catch (error) {
          console.error("è·å–ä¿¡æ¯å¤±è´¥:", error);
          showStatus(elements.getInfoResult, `è·å–å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å­˜å…¥ETH
      async function depositEth() {
        if (!contract) {
          showStatus(elements.depositStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = elements.depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.depositStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢", "error");
          return;
        }

        try {
          showStatus(elements.depositStatus, `æ­£åœ¨å­˜å…¥ ${amount} ETH...`, "info", true);

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(elements.depositStatus, `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.depositStatus, `å­˜æ¬¾æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`, "success");

          elements.depositAmount.val("");
          await getContractBalance();

        } catch (error) {
          console.error("å­˜æ¬¾å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜äº¤æ˜“è´¹ç”¨";
          }

          showStatus(elements.depositStatus, `å­˜æ¬¾å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // æå–ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus(elements.withdrawStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = elements.withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.withdrawStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„æå–é‡‘é¢", "error");
          return;
        }

        try {
          showStatus(elements.withdrawStatus, `æ­£åœ¨æå– ${amount} ETH...`, "info", true);

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(elements.withdrawStatus, `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.withdrawStatus, `æå–æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`, "success");

          elements.withdrawAmount.val("");
          await getContractBalance();

        } catch (error) {
          console.error("æå–å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "åˆçº¦ä½™é¢ä¸è¶³";
          }

          showStatus(elements.withdrawStatus, `æå–å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // è½¬ç§»åˆ°æ‰€æœ‰è€…
      async function transferToOwner() {
        if (!contract) {
          showStatus(elements.transferToOwnerStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus(elements.transferToOwnerStatus, "æ­£åœ¨è½¬ç§»èµ„é‡‘åˆ°æ‰€æœ‰è€…...", "info", true);

          const tx = await contract.transferToOwner();
          showStatus(elements.transferToOwnerStatus, `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.transferToOwnerStatus, `è½¬ç§»æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`, "success");

          await getContractBalance();

        } catch (error) {
          console.error("è½¬ç§»å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "åªæœ‰åˆçº¦æ‰€æœ‰è€…æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ";
          } else if (error.message.includes("No balance")) {
            errorMessage = "åˆçº¦æ²¡æœ‰ä½™é¢å¯è½¬ç§»";
          }

          showStatus(elements.transferToOwnerStatus, `è½¬ç§»å¤±è´¥: ${errorMessage}`, "error");
        }
      }

      // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
      $(document).ready(function () {
        // ç»‘å®šäº‹ä»¶
        elements.connectWallet.on("click", connectWallet);
        elements.disconnectWallet.on("click", disconnectWallet);
        elements.setInfoBtn.on("click", setInfo);
        elements.getInfoBtn.on("click", getInfo);
        elements.depositBtn.on("click", depositEth);
        elements.withdrawBtn.on("click", withdrawEth);
        elements.transferToOwnerBtn.on("click", transferToOwner);

        // å›è½¦é”®æ”¯æŒ
        elements.nameInput.add(elements.ageInput).on("keypress", function(e) {
          if (e.which === 13) setInfo();
        });

        elements.depositAmount.on("keypress", function(e) {
          if (e.which === 13) depositEth();
        });

        elements.withdrawAmount.on("keypress", function(e) {
          if (e.which === 13) withdrawEth();
        });

        // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥:", error);
            });
        }
      });
    </script>
  </body>
</html>