      // 断开连接
      function disconnectWallet() {
        provider = null;
        signer = null;
        infoContract = null;
        payableContract = null;
        currentAccount = null;

        // 停止所有事件监听
        stopAllEventListeners();

        updateConnectionUI(false);
        updateConnectionIndicator(false);
        showStatus($connectionStatus, '已断开钱包连接', 'info');
        clearAllResults();
      }

      // 停止所有事件监听
      function stopAllEventListeners() {
        if (infoEventListener && infoContract) {
          infoContract.off('Instructor', infoEventListener);
          infoEventListener = null;
        }
        
        if (payableContract) {
          if (depositEventListener) {
            payableContract.off('Deposit', depositEventListener);
            depositEventListener = null;
          }
          
          if (withdrawEventListener) {
            payableContract.off('Withdraw', withdrawEventListener);
            withdrawEventListener = null;
          }
        }
      }

      // 更新连接状态 UI
      function updateConnectionUI(connected) {
        if (connected) {
          $connectWalletBtn.addClass('hidden');
          $disconnectWalletBtn.removeClass('hidden');
          $accountInfo.removeClass('hidden');
          $contractTabs.removeClass('hidden');
          $accountInfo.text(`已连接账户: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`);
        } else {
          $connectWalletBtn.removeClass('hidden');
          $disconnectWalletBtn.addClass('hidden');
          $accountInfo.addClass('hidden');
          $contractTabs.addClass('hidden');
          $infoContractSection.addClass('hidden');
          $payableDemoSection.addClass('hidden');
        }
      }

      // 清除所有结果
      function clearAllResults() {
        // 清除InfoContract相关状态
        clearStatus($sayHiResult);
        clearStatus($setInfoStatus);
        clearStatus($getInfoResult);
        clearStatus($eventLog);
        
        // 清除PayableDemo相关状态
        clearStatus($balanceDisplay);
        clearStatus($depositStatus);
        clearStatus($withdrawStatus);
        clearStatus($payableEventLog);
      }

      // 切换合约视图
      function switchContract(contractType) {
        activeContract = contractType;
        
        if (contractType === 'infoContract') {
          $infoContractSection.removeClass('hidden');
          $payableDemoSection.addClass('hidden');
          $('.contract-tab[data-contract="infoContract"]').addClass('active');
          $('.contract-tab[data-contract="payableDemo"]').removeClass('active');
        } else {
          $infoContractSection.addClass('hidden');
          $payableDemoSection.removeClass('hidden');
          $('.contract-tab[data-contract="infoContract"]').removeClass('active');
          $('.contract-tab[data-contract="payableDemo"]').addClass('active');
        }
      }

      //===== InfoContract 功能 =====//

      // sayHi 函数
      async function callSayHi() {
        if (!infoContract) {
          showStatus($sayHiResult, '请先连接钱包', 'error');
          return;
        }

        try {
          showStatus($sayHiResult, '正在调用 sayHi()...', 'info');
          const result = await infoContract.sayHi();
          showStatus($sayHiResult, `sayHi() 返回: "${result}"`, 'success');
        } catch (error) {
          console.error('调用 sayHi 失败:', error);
          showStatus($sayHiResult, `调用失败: ${error.message}`, 'error');
        }
      }

      // 设置信息
      async function setInfo() {
        if (!infoContract) {
          showStatus($setInfoStatus, '请先连接钱包', 'error');
          return;
        }

        const name = $nameInput.val().trim();
        const age = parseInt($ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus($setInfoStatus, '请输入有效的姓名和年龄', 'error');
          return;
        }

        try {
          showStatus($setInfoStatus, '正在设置信息...', 'info');

          const tx = await infoContract.setInfo(name, age);
          showStatus($setInfoStatus, `交易已发送，交易哈希: ${tx.hash}`, 'info');

          const receipt = await tx.wait();
          showStatus($setInfoStatus, `设置成功！区块号: ${receipt.blockNumber}`, 'success');

          $nameInput.val('');
          $ageInput.val('');
        } catch (error) {
          console.error('设置信息失败:', error);
          let errorMessage = error.message;

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = '用户拒绝了交易';
          } else if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage = '余额不足';
          }

          showStatus($setInfoStatus, `设置失败: ${errorMessage}`, 'error');
        }
      }

      // 获取信息
      async function getInfo() {
        if (!infoContract) {
          showStatus($getInfoResult, '请先连接钱包', 'error');
          return;
        }

        try {
          showStatus($getInfoResult, '正在获取信息...', 'info');
          const result = await infoContract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== '0') {
            showStatus($getInfoResult, `当前信息 - 姓名: "${name}", 年龄: ${age.toString()}`, 'success');
          } else {
            showStatus($getInfoResult, '暂无信息或信息为空', 'info');
          }
        } catch (error) {
          console.error('获取信息失败:', error);
          showStatus($getInfoResult, `获取失败: ${error.message}`, 'error');
        }
      }

      // 开始监听信息合约事件
      function startInfoListening() {
        if (!infoContract) {
          showStatus($eventLog, '请先连接钱包', 'error');
          return;
        }

        if (infoEventListener) {
          showStatus($eventLog, '已在监听事件中...', 'info');
          return;
        }

        infoEventListener = (...args) => {
          const event = args[args.length - 1];
          const [name, age] = args.slice(0, -1);

          const timestamp = new Date().toLocaleString();
          const eventInfo = `
            <div class="status success">
              [${timestamp}] 检测到 Instructor 事件<br>
              姓名: "${name}", 年龄: ${age.toString()}<br>
              交易哈希: ${event.transactionHash || event.log?.transactionHash || 'N/A'}
            </div>
          `;
          $eventLog.html(eventInfo + $eventLog.html());
        };

        infoContract.on('Instructor', infoEventListener);
        showStatus($eventLog, '开始监听 Instructor 事件...', 'info');
      }

      // 停止监听信息合约事件
      function stopInfoListening() {
        if (infoEventListener && infoContract) {
          infoContract.off('Instructor', infoEventListener);
          infoEventListener = null;
          showStatus($eventLog, '已停止监听事件', 'info');
        } else {
          showStatus($eventLog, '当前没有在监听事件', 'info');
        }
      }

      //===== PayableDemo 功能 =====//

      // 格式化ETH金额
      function formatEth(wei) {
        return ethers.formatEther(wei);
      }

      // 解析ETH金额为wei
      function parseEth(eth) {
        return ethers.parseEther(eth.toString());
      }

      // 获取合约余额
      async function getContractBalance() {
        if (!payableContract) {
          showStatus($balanceDisplay, '请先连接钱包', 'error');
          return;
        }

        try {
          showStatus($balanceDisplay, '正在查询合约余额...', 'info');
          const balance = await payableContract.getBalance();
          
          const balanceInEth = formatEth(balance);
          $balanceDisplay.html(`
            <div class="balance-display">
              当前合约余额: <span class="amount-highlight"><span class="eth-icon">Ξ</span>${balanceInEth}</span> ETH
            </div>
          `);
        } catch (error) {
          console.error('获取余额失败:', error);
          showStatus($balanceDisplay, `获取余额失败: ${error.message}`, 'error');
        }
      }

      // 存入ETH
      async function depositEth() {
        if (!payableContract) {
          showStatus($depositStatus, '请先连接钱包', 'error');
          return;
        }

        const amount = $depositAmount.val();
        
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($depositStatus, '请输入有效的存款金额', 'error');
          return;
        }

        try {
          showStatus($depositStatus, `正在存入 ${amount} ETH...`, 'info');
          
          const amountWei = parseEth(amount);
          const tx = await payableContract.deposit({ value: amountWei });
          
          showStatus($depositStatus, `交易已发送，交易哈希: ${tx.hash}`, 'info');

          const receipt = await tx.wait();
          showStatus($depositStatus, `存款成功！区块号: ${receipt.blockNumber}`, 'success');

          $depositAmount.val('');
          
          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error('存款失败:', error);
          let errorMessage = error.message;

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = '用户拒绝了交易';
          } else if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage = '余额不足';
          }

          showStatus($depositStatus, `存款失败: ${errorMessage}`, 'error');
        }
      }

      // 提取ETH
      async function withdrawEth() {
        if (!payableContract) {
          showStatus($withdrawStatus, '请先连接钱包', 'error');
          return;
        }

        const amount = $withdrawAmount.val();
        
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($withdrawStatus, '请输入有效的提取金额', 'error');
          return;
        }

        try {
          showStatus($withdrawStatus, `正在提取 ${amount} ETH...`, 'info');
          
          const amountWei = parseEth(amount);
          const tx = await payableContract.withdraw(amountWei);
          
          showStatus($withdrawStatus, `交易已发送，交易哈希: ${tx.hash}`, 'info');

          const receipt = await tx.wait();
          showStatus($withdrawStatus, `提取成功！区块号: ${receipt.blockNumber}`, 'success');

          $withdrawAmount.val('');
          
          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error('提取失败:', error);
          let errorMessage = error.message;

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = '用户拒绝了交易';
          } else if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage = '余额不足';
          } else if (error.message.includes('Insufficient balance')) {
            errorMessage = '合约余额不足';
          }

          showStatus($withdrawStatus, `提取失败: ${errorMessage}`, 'error');
        }
      }

      // 开始监听支付合约事件
      function startPayableListening() {
        if (!payableContract) {
          showStatus($payableEventLog, '请先连接钱包', 'error');
          return;
        }

        if (depositEventListener || withdrawEventListener) {
          showStatus($payableEventLog, '已在监听事件中...', 'info');
          return;
        }

        // 监听存款事件
        depositEventListener = (sender, amount, event) => {
          const timestamp = new Date().toLocaleString();
          const amountInEth = formatEth(amount);
          const isSelf = sender.toLowerCase() === currentAccount.toLowerCase() ? ' (您)' : '';
          
          const eventInfo = `
            <div class="status success">
              [${timestamp}] 检测到 Deposit 事件<br>
              发送者: ${sender.slice(0, 6)}...${sender.slice(-4)}${isSelf}<br>
              金额: <span class="amount-highlight"><span class="eth-icon">Ξ</span>${amountInEth}</span> ETH<br>
              交易哈希: ${event.transactionHash || event.log?.transactionHash || 'N/A'}
            </div>
          `;
          $payableEventLog.html(eventInfo + $payableEventLog.html());
        };

        // 监听提款事件
        withdrawEventListener = (receiver, amount, event) => {
          const timestamp = new Date().toLocaleString();
          const amountInEth = formatEth(amount);
          const isSelf = receiver.toLowerCase() === currentAccount.toLowerCase() ? ' (您)' : '';
          
          const eventInfo = `
            <div class="status success">
              [${timestamp}] 检测到 Withdraw 事件<br>
              接收者: ${receiver.slice(0, 6)}...${receiver.slice(-4)}${isSelf}<br>
              金额: <span class="amount-highlight"><span class="eth-icon">Ξ</span>${amountInEth}</span> ETH<br>
              交易哈希: ${event.transactionHash || event.log?.transactionHash || 'N/A'}
            </div>
          `;
          $payableEventLog.html(eventInfo + $payableEventLog.html());
        };

        payableContract.on('Deposit', depositEventListener);
        payableContract.on('Withdraw', withdrawEventListener);
        showStatus($payableEventLog, '开始监听 Deposit 和 Withdraw 事件...', 'info');
      }

      // 停止监听支付合约事件
      function stopPayableListening() {
        if (payableContract) {
          if (depositEventListener) {
            payableContract.off('Deposit', depositEventListener);
            depositEventListener = null;
          }
          
          if (withdrawEventListener) {
            payableContract.off('Withdraw', withdrawEventListener);
            withdrawEventListener = null;
          }
          
          showStatus($payableEventLog, '已停止监听事件', 'info');
        } else {
          showStatus($payableEventLog, '当前没有在监听事件', 'info');
        }
      }

      // 监听账户变化
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on('chainChanged', () => {
          window.location.reload();
        });
      }

      // 事件监听器
      $(document).ready(function () {
        // 创建背景粒子
        createParticles();

        // 钱包连接
        $connectWalletBtn.on('click', connectWallet);
        $disconnectWalletBtn.on('click', disconnectWallet);
        
        // 合约切换
        $('.contract-tab').on('click', function() {
          const contractType = $(this).data('contract');
          switchContract(contractType);
        });

        // InfoContract功能
        $sayHiBtn.on('click', callSayHi);
        $setInfoBtn.on('click', setInfo);
        $getInfoBtn.on('click', getInfo);
        $startListeningBtn.on('click', startInfoListening);
        $stopListeningBtn.on('click', stopInfoListening);

        // PayableDemo功能
        $getBalanceBtn.on('click', getContractBalance);
        $depositBtn.on('click', depositEth);
        $withdrawBtn.on('click', withdrawEth);
        $startPayableListeningBtn.on('click', startPayableListening);
        $stopPayableListeningBtn.on('click', stopPayableListening);

        // 页面加载完成后检查连接状态
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: 'eth_accounts' })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error('检查连接状态失败:', error);
            });
        }
      });
    </script>
  </body>
</html>