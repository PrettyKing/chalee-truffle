<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- 钱包连接部分 -->
      <div class="section">
        <div class="data-stream"></div>
        <h3>🔗 钱包连接</h3>
        <button id="connectWallet">连接 MetaMask</button>
        <button id="disconnectWallet" class="hidden">断开连接</button>
        <div id="accountInfo" class="hidden"></div>
        <div id="connectionStatus"></div>
        <!-- 合约所有者 -->
          <div id="ownerInfo"></div>

        <!-- 合约余额 -->
          <button id="getBalanceBtn">查询合约余额</button>
          <div id="balanceDisplay"></div>
        </div>
      </div>
      <!-- sayHi 测试 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 0.5s"></div>
        <h3>👋 Say Hi 测试</h3>
        <button id="sayHiBtn">调用 sayHi()</button>
        <div id="sayHiResult"></div>
      </div>

      <!-- 设置信息 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 1s"></div>
        <h3>📝 设置信息</h3>
        <div>
          <input type="text" id="nameInput" placeholder="输入姓名" />
          <input type="number" id="ageInput" placeholder="输入年龄" />
          <button id="setInfoBtn">设置信息</button>
        </div>
        <div id="setInfoStatus"></div>
      </div>

      <!-- 获取信息 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 1.5s"></div>
        <h3>📋 获取信息</h3>
        <button id="getInfoBtn">获取当前信息</button>
        <div id="getInfoResult"></div>
      </div>

      <!-- 存款功能 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 1s"></div>
        <h3>📥 存入ETH</h3>
        <div>
          <input
            type="number"
            id="depositAmount"
            placeholder="输入存款金额（ETH）"
            step="0.001"
            min="0.001"
          />
          <button id="depositBtn">存入</button>
        </div>
        <div id="depositStatus"></div>
      </div>

      <!-- 提款功能 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 1.5s"></div>
        <h3>📤 提取ETH</h3>
        <div>
          <input
            type="number"
            id="withdrawAmount"
            placeholder="输入提取金额（ETH）"
            step="0.001"
            min="0.001"
          />
          <button id="withdrawBtn">提取</button>
        </div>
        <div id="withdrawStatus"></div>
      </div>

      <!-- 转移到所有者功能 -->
      <div class="section">
        <div class="data-stream" style="animation-delay: 1.8s"></div>
        <h3>🏆 转移到所有者</h3>
        <div>
          <button id="transferToOwnerBtn">转移所有余额到合约所有者</button>
          <div id="transferToOwnerStatus"></div>
        </div>
      </div>
    </div>

    <script>
      // 合约配置 - 使用合并后的合约
      const CONTRACT_ADDRESS = "0xa14f1Fded1d7Eec3d94E7069aA02D924D1db8860"; // 部署后需要更新为实际地址
      const CONTRACT_ABI = [
        {
          inputs: [],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "sender",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Deposit",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "string",
              name: "name",
              type: "string",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "age",
              type: "uint256",
            },
          ],
          name: "Instructor",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "receiver",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Withdraw",
          type: "event",
        },
        {
          inputs: [],
          name: "balance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getInfo",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [
            {
              internalType: "address",
              name: "",
              type: "address",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "sayHi",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
          ],
          stateMutability: "pure",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "_name",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "_age",
              type: "uint256",
            },
          ],
          name: "setInfo",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "transferToOwner",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "withdraw",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      // 全局变量
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;
      let infoEventListener = null;
      let depositEventListener = null;
      let withdrawEventListener = null;
      let activeContract = "infoContract";

      // DOM 元素
      const $connectWalletBtn = $("#connectWallet");
      const $disconnectWalletBtn = $("#disconnectWallet");
      const $accountInfo = $("#accountInfo");
      const $connectionStatus = $("#connectionStatus");
      const $contractTabs = $("#contractTabs");
      const $connectionIndicator = $("#connectionIndicator");

      // InfoContract DOM元素
      const $infoContractSection = $("#infoContractSection");
      const $sayHiBtn = $("#sayHiBtn");
      const $sayHiResult = $("#sayHiResult");
      const $setInfoBtn = $("#setInfoBtn");
      const $nameInput = $("#nameInput");
      const $ageInput = $("#ageInput");
      const $setInfoStatus = $("#setInfoStatus");
      const $getInfoBtn = $("#getInfoBtn");
      const $getInfoResult = $("#getInfoResult");
      const $eventLog = $("#eventLog");

      // PayableDemo DOM元素
      const $payableDemoSection = $("#payableDemoSection");
      const $ownerInfo = $("#ownerInfo");
      const $getBalanceBtn = $("#getBalanceBtn");
      const $balanceDisplay = $("#balanceDisplay");
      const $depositAmount = $("#depositAmount");
      const $depositBtn = $("#depositBtn");
      const $depositStatus = $("#depositStatus");
      const $withdrawAmount = $("#withdrawAmount");
      const $withdrawBtn = $("#withdrawBtn");
      const $withdrawStatus = $("#withdrawStatus");
      const $transferToOwnerBtn = $("#transferToOwnerBtn");
      const $transferToOwnerStatus = $("#transferToOwnerStatus");

      // 创建浮动粒子
      function createParticles() {
        const particlesContainer = document.getElementById("particles");
        for (let i = 0; i < 50; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.top = Math.random() * 100 + "%";
          particle.style.width = Math.random() * 4 + 2 + "px";
          particle.style.height = particle.style.width;
          particle.style.animationDelay = Math.random() * 6 + "s";
          particle.style.animationDuration = Math.random() * 3 + 3 + "s";
          particlesContainer.appendChild(particle);
        }
      }

      // 工具函数
      function showStatus($element, message, type = "info") {
        const loadingSpinner =
          type === "info" && message.includes("正在")
            ? '<div class="loading"></div>'
            : "";
        $element.html(
          `<div class="status ${type}">${loadingSpinner}${message}</div>`
        );
      }

      function clearStatus($element) {
        $element.html("");
      }

      // 更新连接指示器
      function updateConnectionIndicator(connected) {
        if (connected) {
          $connectionIndicator.addClass("connected");
        } else {
          $connectionIndicator.removeClass("connected");
        }
      }

      // 检查是否安装了 MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask 已安装");
          return true;
        } else {
          showStatus($connectionStatus, "请安装 MetaMask 钱包扩展！", "error");
          return false;
        }
      }

      // 连接钱包
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus($connectionStatus, "正在连接钱包...", "info");

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("没有找到账户");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          // 初始化合约
          contract = new ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            signer
          );

          updateConnectionUI(true);
          updateConnectionIndicator(true);
          showStatus($connectionStatus, "钱包连接成功！", "success");

          // 获取合约所有者信息
          getOwnerInfo();
        } catch (error) {
          console.error("连接钱包失败:", error);
          showStatus($connectionStatus, `连接失败: ${error.message}`, "error");
          updateConnectionIndicator(false);
        }
      }

      // 断开连接
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        // 停止所有事件监听
        stopAllEventListeners();

        updateConnectionUI(false);
        updateConnectionIndicator(false);
        showStatus($connectionStatus, "已断开钱包连接", "info");
        clearAllResults();
      }

      // 停止所有事件监听
      function stopAllEventListeners() {
        if (contract) {
          if (infoEventListener) {
            contract.off("Instructor", infoEventListener);
            infoEventListener = null;
          }

          if (depositEventListener) {
            contract.off("Deposit", depositEventListener);
            depositEventListener = null;
          }

          if (withdrawEventListener) {
            contract.off("Withdraw", withdrawEventListener);
            withdrawEventListener = null;
          }
        }
      }

      // 更新连接状态 UI
      function updateConnectionUI(connected) {
        if (connected) {
          $connectWalletBtn.addClass("hidden");
          $disconnectWalletBtn.removeClass("hidden");
          $accountInfo.removeClass("hidden");
          $contractTabs.removeClass("hidden");
          $accountInfo.text(
            `已连接账户: ${currentAccount.slice(0, 6)}...${currentAccount.slice(
              -4
            )}`
          );
          $infoContractSection.removeClass("hidden");
        } else {
          $connectWalletBtn.removeClass("hidden");
          $disconnectWalletBtn.addClass("hidden");
          $accountInfo.addClass("hidden");
          $contractTabs.addClass("hidden");
          $infoContractSection.addClass("hidden");
          $payableDemoSection.addClass("hidden");
        }
      }

      // 清除所有结果
      function clearAllResults() {
        // 清除InfoContract相关状态
        clearStatus($sayHiResult);
        clearStatus($setInfoStatus);
        clearStatus($getInfoResult);
        clearStatus($eventLog);

        // 清除PayableDemo相关状态
        clearStatus($ownerInfo);
        clearStatus($balanceDisplay);
        clearStatus($depositStatus);
        clearStatus($withdrawStatus);
        clearStatus($transferToOwnerStatus);
      }

      // 切换合约视图
      function switchContract(contractType) {
        activeContract = contractType;

        if (contractType === "infoContract") {
          $infoContractSection.removeClass("hidden");
          $payableDemoSection.addClass("hidden");
          $('.contract-tab[data-contract="infoContract"]').addClass("active");
          $('.contract-tab[data-contract="payableDemo"]').removeClass("active");
        } else {
          $infoContractSection.addClass("hidden");
          $payableDemoSection.removeClass("hidden");
          $('.contract-tab[data-contract="infoContract"]').removeClass(
            "active"
          );
          $('.contract-tab[data-contract="payableDemo"]').addClass("active");

          // 刷新余额和所有者信息
          getOwnerInfo();
          getContractBalance();
        }
      }

      //===== InfoContract 功能 =====//

      // sayHi 函数
      async function callSayHi() {
        if (!contract) {
          showStatus($sayHiResult, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($sayHiResult, "正在调用 sayHi()...", "info");
          const result = await contract.sayHi();
          showStatus($sayHiResult, `sayHi() 返回: "${result}"`, "success");
        } catch (error) {
          console.error("调用 sayHi 失败:", error);
          showStatus($sayHiResult, `调用失败: ${error.message}`, "error");
        }
      }

      // 设置信息
      async function setInfo() {
        if (!contract) {
          showStatus($setInfoStatus, "请先连接钱包", "error");
          return;
        }

        const name = $nameInput.val().trim();
        const age = parseInt($ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus($setInfoStatus, "请输入有效的姓名和年龄", "error");
          return;
        }

        try {
          showStatus($setInfoStatus, "正在设置信息...", "info");

          const tx = await contract.setInfo(name, age);
          showStatus(
            $setInfoStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $setInfoStatus,
            `设置成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          $nameInput.val("");
          $ageInput.val("");
        } catch (error) {
          console.error("设置信息失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足";
          }

          showStatus($setInfoStatus, `设置失败: ${errorMessage}`, "error");
        }
      }

      // 获取信息
      async function getInfo() {
        if (!contract) {
          showStatus($getInfoResult, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($getInfoResult, "正在获取信息...", "info");
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(
              $getInfoResult,
              `当前信息 - 姓名: "${name}", 年龄: ${age.toString()}`,
              "success"
            );
          } else {
            showStatus($getInfoResult, "暂无信息或信息为空", "info");
          }
        } catch (error) {
          console.error("获取信息失败:", error);
          showStatus($getInfoResult, `获取失败: ${error.message}`, "error");
        }
      }

      // 开始监听信息合约事件
      function startInfoListening() {
        if (!contract) {
          showStatus($eventLog, "请先连接钱包", "error");
          return;
        }

        if (infoEventListener) {
          showStatus($eventLog, "已在监听事件中...", "info");
          return;
        }

        infoEventListener = (...args) => {
          const event = args[args.length - 1];
          const [name, age] = args.slice(0, -1);

          const timestamp = new Date().toLocaleString();
          const eventInfo = `
            <div class="status success">
              [${timestamp}] 检测到 Instructor 事件<br>
              姓名: "${name}", 年龄: ${age.toString()}<br>
              交易哈希: ${
                event.transactionHash || event.log?.transactionHash || "N/A"
              }
            </div>
          `;
          $eventLog.html(eventInfo + $eventLog.html());
        };

        contract.on("Instructor", infoEventListener);
        showStatus($eventLog, "开始监听 Instructor 事件...", "info");
      }

      // 停止监听信息合约事件
      function stopInfoListening() {
        if (infoEventListener && contract) {
          contract.off("Instructor", infoEventListener);
          infoEventListener = null;
          showStatus($eventLog, "已停止监听事件", "info");
        } else {
          showStatus($eventLog, "当前没有在监听事件", "info");
        }
      }

      //===== PayableDemo 功能 =====//

      // 格式化ETH金额
      function formatEth(wei) {
        return ethers.formatEther(wei);
      }

      // 解析ETH金额为wei
      function parseEth(eth) {
        return ethers.parseEther(eth.toString());
      }

      // 获取合约所有者信息
      async function getOwnerInfo() {
        if (!contract) {
          showStatus($ownerInfo, "请先连接钱包", "error");
          return;
        }

        try {
          const owner = await contract.owner();

          const isCurrentUserOwner =
            owner.toLowerCase() === currentAccount.toLowerCase();
          const ownerDisplay = `
            <div class="owner-info">
              <div class="owner-address">
                合约所有者: ${owner.slice(0, 8)}...${owner.slice(-6)}
                ${
                  isCurrentUserOwner
                    ? '<span class="owner-badge">您是所有者</span>'
                    : ""
                }
              </div>
              <div>
                ${
                  isCurrentUserOwner
                    ? '<div style="color: #ffd700; font-size: 0.85rem;">您可以执行所有者特权操作</div>'
                    : '<div style="color: #ff6b6b; font-size: 0.85rem;">您不是合约所有者</div>'
                }
              </div>
            </div>
          `;

          $ownerInfo.html(ownerDisplay);

          // 如果当前用户不是所有者，禁用转移到所有者按钮
          if (!isCurrentUserOwner) {
            $transferToOwnerBtn.prop("disabled", true);
            $transferToOwnerBtn.css("opacity", 0.5);
          } else {
            $transferToOwnerBtn.prop("disabled", false);
            $transferToOwnerBtn.css("opacity", 1);
          }
        } catch (error) {
          console.error("获取所有者信息失败:", error);
          showStatus(
            $ownerInfo,
            `获取所有者信息失败: ${error.message}`,
            "error"
          );
        }
      }

      // 获取合约余额
      async function getContractBalance() {
        if (!contract) {
          showStatus($balanceDisplay, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($balanceDisplay, "正在查询合约余额...", "info");
          const balance = await contract.getBalance();

          const balanceInEth = formatEth(balance);
          $balanceDisplay.html(`
            <div class="balance-display">
              当前合约余额: <span class="amount-highlight"><span class="eth-icon">Ξ</span>${balanceInEth}</span> ETH
            </div>
          `);
        } catch (error) {
          console.error("获取余额失败:", error);
          showStatus(
            $balanceDisplay,
            `获取余额失败: ${error.message}`,
            "error"
          );
        }
      }

      // 存入ETH
      async function depositEth() {
        if (!contract) {
          showStatus($depositStatus, "请先连接钱包", "error");
          return;
        }

        const amount = $depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($depositStatus, "请输入有效的存款金额", "error");
          return;
        }

        try {
          showStatus($depositStatus, `正在存入 ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(
            $depositStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $depositStatus,
            `存款成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          $depositAmount.val("");

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("存款失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足";
          }

          showStatus($depositStatus, `存款失败: ${errorMessage}`, "error");
        }
      }

      // 提取ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus($withdrawStatus, "请先连接钱包", "error");
          return;
        }

        const amount = $withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus($withdrawStatus, "请输入有效的提取金额", "error");
          return;
        }

        try {
          showStatus($withdrawStatus, `正在提取 ${amount} ETH...`, "info");

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(
            $withdrawStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $withdrawStatus,
            `提取成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          $withdrawAmount.val("");

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("提取失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "合约余额不足";
          }

          showStatus($withdrawStatus, `提取失败: ${errorMessage}`, "error");
        }
      }

      // 转移到所有者
      async function transferToOwner() {
        if (!contract) {
          showStatus($transferToOwnerStatus, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus($transferToOwnerStatus, "正在转移资金到所有者...", "info");

          const tx = await contract.transferToOwner();

          showStatus(
            $transferToOwnerStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            $transferToOwnerStatus,
            `转移成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          // 刷新余额
          getContractBalance();
        } catch (error) {
          console.error("转移失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "只有合约所有者才能执行此操作";
          } else if (error.message.includes("No balance")) {
            errorMessage = "合约没有余额可转移";
          }

          showStatus(
            $transferToOwnerStatus,
            `转移失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 监听账户变化
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // 事件监听器
      $(document).ready(function () {
        // 创建背景粒子
        createParticles();

        // 钱包连接
        $connectWalletBtn.on("click", connectWallet);
        $disconnectWalletBtn.on("click", disconnectWallet);

        // 合约切换
        $(".contract-tab").on("click", function () {
          const contractType = $(this).data("contract");
          switchContract(contractType);
        });

        // InfoContract功能
        $sayHiBtn.on("click", callSayHi);
        $setInfoBtn.on("click", setInfo);
        $getInfoBtn.on("click", getInfo);

        // PayableDemo功能
        $getBalanceBtn.on("click", getContractBalance);
        $depositBtn.on("click", depositEth);
        $withdrawBtn.on("click", withdrawEth);
        $transferToOwnerBtn.on("click", transferToOwner);

        // 页面加载完成后检查连接状态
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("检查连接状态失败:", error);
            });
        }
      });
    </script>
  </body>
</html>
