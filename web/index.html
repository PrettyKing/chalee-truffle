<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp - Enhanced</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #ffffff;
        overflow-x: hidden;
        position: relative;
      }

      /* 动画背景粒子效果 */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
        animation: float 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes float {
        0%, 100% { opacity: 0.3; transform: translateY(0px); }
        50% { opacity: 0.8; transform: translateY(-20px); }
      }

      /* 玻璃态效果 */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
      }

      /* 头部增强 */
      .header {
        text-align: center;
        margin-bottom: 50px;
        padding: 30px 0;
      }

      h1 {
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        letter-spacing: -0.02em;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 300;
        margin-bottom: 30px;
      }

      /* 连接状态指示器 */
      .connection-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 0.95rem;
        margin-bottom: 20px;
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ff6b6b;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #51cf66;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      /* 功能卡片网格 */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .card {
        padding: 30px;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .card h3 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }

      .card-icon {
        font-size: 1.8rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      /* 输入控件增强 */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      .input-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      input[type="text"],
      input[type="number"] {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px 20px;
        color: #ffffff;
        font-size: 1rem;
        flex: 1;
        min-width: 200px;
        transition: all 0.3s ease;
        font-weight: 400;
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.6);
        font-weight: 300;
      }

      /* 按钮系统升级 */
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        letter-spacing: 0.5px;
        min-width: 140px;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        filter: brightness(1.1);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.6;
      }

      /* 专用按钮样式 */
      .btn-primary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
      }

      .btn-primary:hover {
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .btn-danger:hover {
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
      }

      .btn-success {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        box-shadow: 0 4px 15px rgba(81, 207, 102, 0.4);
      }

      .btn-success:hover {
        box-shadow: 0 8px 25px rgba(81, 207, 102, 0.6);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
        color: #333;
        box-shadow: 0 4px 15px rgba(255, 212, 59, 0.4);
      }

      .btn-warning:hover {
        box-shadow: 0 8px 25px rgba(255, 212, 59, 0.6);
      }

      /* 状态消息增强 */
      .status-message {
        padding: 18px 24px;
        margin: 20px 0;
        border-radius: 12px;
        border-left: 4px solid;
        animation: slideInUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-success {
        background: rgba(81, 207, 102, 0.15);
        border-left-color: #51cf66;
        color: #d3f9d8;
      }

      .status-error {
        background: rgba(255, 107, 107, 0.15);
        border-left-color: #ff6b6b;
        color: #ffe0e0;
      }

      .status-info {
        background: rgba(79, 172, 254, 0.15);
        border-left-color: #4facfe;
        color: #d0ebff;
      }

      .status-warning {
        background: rgba(255, 212, 59, 0.15);
        border-left-color: #ffd43b;
        color: #fff3bf;
      }

      /* 账户信息样式 */
      .account-info {
        background: rgba(81, 207, 102, 0.1);
        border: 2px solid rgba(81, 207, 102, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
        font-weight: 500;
        backdrop-filter: blur(10px);
      }

      .account-address {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.9rem;
        word-break: break-all;
        margin-top: 8px;
        opacity: 0.9;
      }

      /* 余额显示增强 */
      .balance-display {
        background: linear-gradient(135deg, rgba(255, 212, 59, 0.2) 0%, rgba(250, 176, 5, 0.2) 100%);
        border: 2px solid rgba(255, 212, 59, 0.4);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .balance-amount {
        font-size: 2rem;
        font-weight: 700;
        color: #ffd43b;
        text-shadow: 0 2px 10px rgba(255, 212, 59, 0.3);
        margin-bottom: 8px;
      }

      .balance-label {
        font-size: 1rem;
        opacity: 0.8;
        font-weight: 400;
      }

      /* 所有者信息 */
      .owner-info {
        background: linear-gradient(135deg, rgba(118, 75, 162, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
        border: 2px solid rgba(118, 75, 162, 0.4);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .owner-badge {
        display: inline-block;
        background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(255, 212, 59, 0.3);
      }

      /* 加载动画增强 */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 1s linear infinite;
        margin-right: 12px;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* 响应式设计增强 */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 2.5rem;
        }

        .grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .card {
          padding: 25px;
        }

        .input-row {
          flex-direction: column;
        }

        input[type="text"],
        input[type="number"] {
          min-width: unset;
        }

        .btn {
          width: 100%;
          margin: 5px 0;
        }
      }

      /* 隐藏类 */
      .hidden {
        display: none !important;
      }

      /* 工具提示 */
      .tooltip {
        position: relative;
        cursor: help;
      }

      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
      }

      .tooltip:hover::after {
        opacity: 1;
      }

      /* 页面底部空间 */
      .footer-space {
        height: 60px;
      }

      /* 增强的卡片动画 */
      .card {
        animation: cardFade 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
      }

      .card:nth-child(1) { animation-delay: 0.1s; }
      .card:nth-child(2) { animation-delay: 0.2s; }
      .card:nth-child(3) { animation-delay: 0.3s; }
      .card:nth-child(4) { animation-delay: 0.4s; }
      .card:nth-child(5) { animation-delay: 0.5s; }

      @keyframes cardFade {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 增强的头部 -->
      <div class="header">
        <h1>Chalee DApp</h1>
        <p class="subtitle">现代化的以太坊智能合约交互平台</p>
      </div>

      <!-- 钱包连接卡片 -->
      <div class="card glass" style="margin-bottom: 20px;">
        <!-- 连接状态指示器 -->
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="connectionText">未连接</span>
        </div>
        <h3><span class="card-icon">🔗</span>钱包连接</h3>
        <div class="input-group">
          <div class="input-row">
            <button id="connectWallet" class="btn btn-primary">连接 MetaMask</button>
            <button id="disconnectWallet" class="btn btn-danger hidden">断开连接</button>
          </div>
        </div>
        <div id="accountInfo" class="account-info hidden"></div>
        <div id="connectionStatus"></div>
        <div id="ownerInfo"></div>
        <div id="balanceDisplay"></div>
      </div>

      <!-- 功能卡片网格 -->
      <div class="grid">
        <!-- 信息管理卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📝</span>信息管理</h3>
          <div class="input-group">
            <div class="input-row">
              <input type="text" id="nameInput" placeholder="输入姓名" />
              <input type="number" id="ageInput" placeholder="输入年龄" />
            </div>
            <button id="setInfoBtn" class="btn">设置信息</button>
          </div>
          <div id="setInfoStatus"></div>
          
          <div class="input-group" style="margin-top: 25px;">
            <button id="getInfoBtn" class="btn btn-success">获取当前信息</button>
          </div>
          <div id="getInfoResult"></div>
        </div>

        <!-- 存款功能卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📥</span>存入 ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="depositAmount"
              placeholder="输入存款金额（ETH）"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="最小存款金额为 0.001 ETH"
            />
            <button id="depositBtn" class="btn btn-success">存入</button>
          </div>
          <div id="depositStatus"></div>
        </div>

        <!-- 提款功能卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📤</span>提取 ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="withdrawAmount"
              placeholder="输入提取金额（ETH）"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="确保合约有足够余额"
            />
            <button id="withdrawBtn" class="btn btn-primary">提取</button>
          </div>
          <div id="withdrawStatus"></div>
        </div>

        <!-- 所有者操作卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">🏆</span>所有者操作</h3>
          <div class="input-group">
            <button id="transferToOwnerBtn" class="btn btn-warning tooltip" data-tooltip="只有合约所有者可以执行此操作">
              转移所有余额到合约所有者
            </button>
          </div>
          <div id="transferToOwnerStatus"></div>
        </div>
      </div>

      <div class="footer-space"></div>
    </div>

    <script>
      // 合约配置
      const CONTRACT_ADDRESS = "0xa14f1Fded1d7Eec3d94E7069aA02D924D1db8860";
      const CONTRACT_ABI = [
        {
          inputs: [],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "sender",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Deposit",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "string",
              name: "name",
              type: "string",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "age",
              type: "uint256",
            },
          ],
          name: "Instructor",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "receiver",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "Withdraw",
          type: "event",
        },
        {
          inputs: [],
          name: "balance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getInfo",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [
            {
              internalType: "address",
              name: "",
              type: "address",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "sayHi",
          outputs: [
            {
              internalType: "string",
              name: "",
              type: "string",
            },
          ],
          stateMutability: "pure",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "_name",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "_age",
              type: "uint256",
            },
          ],
          name: "setInfo",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "transferToOwner",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "withdraw",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      // 全局变量
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;

      // DOM 元素
      const elements = {
        connectWallet: $("#connectWallet"),
        disconnectWallet: $("#disconnectWallet"),
        accountInfo: $("#accountInfo"),
        connectionStatus: $("#connectionStatus"),
        statusDot: $("#statusDot"),
        connectionText: $("#connectionText"),
        ownerInfo: $("#ownerInfo"),
        balanceDisplay: $("#balanceDisplay"),
        
        // 信息管理
        nameInput: $("#nameInput"),
        ageInput: $("#ageInput"),
        setInfoBtn: $("#setInfoBtn"),
        setInfoStatus: $("#setInfoStatus"),
        getInfoBtn: $("#getInfoBtn"),
        getInfoResult: $("#getInfoResult"),
        
        // 存款
        depositAmount: $("#depositAmount"),
        depositBtn: $("#depositBtn"),
        depositStatus: $("#depositStatus"),
        
        // 提款
        withdrawAmount: $("#withdrawAmount"),
        withdrawBtn: $("#withdrawBtn"),
        withdrawStatus: $("#withdrawStatus"),
        
        // 所有者操作
        transferToOwnerBtn: $("#transferToOwnerBtn"),
        transferToOwnerStatus: $("#transferToOwnerStatus")
      };

      // 工具函数
      function showStatus(element, message, type = "info", showLoading = false) {
        const loadingSpinner = showLoading ? '<div class="loading-spinner"></div>' : '';
        const statusClass = `status-${type}`;
        element.html(`<div class="status-message ${statusClass}">${loadingSpinner}${message}</div>`);
      }

      function clearStatus(element) {
        element.html("");
      }

      function updateConnectionStatus(connected, account = null) {
        const dot = elements.statusDot;
        const text = elements.connectionText;
        
        if (connected) {
          dot.addClass("connected");
          text.text("已连接");
          if (account) {
            const shortAccount = `${account.slice(0, 6)}...${account.slice(-4)}`;
            elements.accountInfo.html(`
              <div class="account-address">当前账户: ${shortAccount}</div>
              <div class="account-address">${account}</div>
            `).removeClass("hidden");
          }
        } else {
          dot.removeClass("connected");
          text.text("未连接");
          elements.accountInfo.addClass("hidden");
        }
      }

      function formatEth(wei) {
        return ethers.formatEther(wei);
      }

      function parseEth(eth) {
        return ethers.parseEther(eth.toString());
      }

      // 检查 MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask 已安装");
          return true;
        } else {
          showStatus(elements.connectionStatus, "请安装 MetaMask 钱包扩展！", "error");
          return false;
        }
      }

      // 连接钱包
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus(elements.connectionStatus, "正在连接钱包...", "info", true);

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("没有找到账户");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          updateConnectionUI(true);
          updateConnectionStatus(true, currentAccount);
          showStatus(elements.connectionStatus, "钱包连接成功！", "success");

          // 获取合约信息
          await Promise.all([
            getOwnerInfo(),
            getContractBalance()
          ]);

        } catch (error) {
          console.error("连接钱包失败:", error);
          showStatus(elements.connectionStatus, `连接失败: ${error.message}`, "error");
          updateConnectionStatus(false);
        }
      }

      // 断开连接
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        updateConnectionUI(false);
        updateConnectionStatus(false);
        showStatus(elements.connectionStatus, "已断开钱包连接", "info");
        clearAllResults();
      }

      // 更新连接状态 UI
      function updateConnectionUI(connected) {
        if (connected) {
          elements.connectWallet.addClass("hidden");
          elements.disconnectWallet.removeClass("hidden");
        } else {
          elements.connectWallet.removeClass("hidden");
          elements.disconnectWallet.addClass("hidden");
        }
      }

      // 清除所有结果
      function clearAllResults() {
        [
          elements.setInfoStatus,
          elements.getInfoResult,
          elements.ownerInfo,
          elements.balanceDisplay,
          elements.depositStatus,
          elements.withdrawStatus,
          elements.transferToOwnerStatus
        ].forEach(clearStatus);
      }

      // 获取合约所有者信息
      async function getOwnerInfo() {
        if (!contract) return;

        try {
          const owner = await contract.owner();
          const isCurrentUserOwner = owner.toLowerCase() === currentAccount.toLowerCase();
          
          const ownerDisplay = `
            <div class="owner-info">
              ${isCurrentUserOwner ? '<div class="owner-badge">您是合约所有者</div>' : ''}
              <div style="font-size: 0.9rem; opacity: 0.9;">
                ${isCurrentUserOwner 
                  ? '您拥有合约的完全控制权' 
                  : '您不是合约所有者，某些功能可能受限'
                }
              </div>
            </div>
          `;

          elements.ownerInfo.html(ownerDisplay);

          // 控制所有者按钮状态
          elements.transferToOwnerBtn.prop("disabled", !isCurrentUserOwner);
          if (!isCurrentUserOwner) {
            elements.transferToOwnerBtn.css("opacity", 0.5);
          } else {
            elements.transferToOwnerBtn.css("opacity", 1);
          }

        } catch (error) {
          console.error("获取所有者信息失败:", error);
          showStatus(elements.ownerInfo, `获取所有者信息失败: ${error.message}`, "error");
        }
      }

      // 获取合约余额
      async function getContractBalance() {
        if (!contract) return;

        try {
          const balance = await contract.getBalance();
          const balanceInEth = formatEth(balance);
          
          elements.balanceDisplay.html(`
            <div class="balance-display">
              <div class="balance-amount">Ξ ${balanceInEth}</div>
              <div class="balance-label">合约当前余额</div>
            </div>
          `);
        } catch (error) {
          console.error("获取余额失败:", error);
          showStatus(elements.balanceDisplay, `获取余额失败: ${error.message}`, "error");
        }
      }

      // 设置信息
      async function setInfo() {
        if (!contract) {
          showStatus(elements.setInfoStatus, "请先连接钱包", "error");
          return;
        }

        const name = elements.nameInput.val().trim();
        const age = parseInt(elements.ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus(elements.setInfoStatus, "请输入有效的姓名和年龄", "error");
          return;
        }

        try {
          showStatus(elements.setInfoStatus, "正在设置信息...", "info", true);

          const tx = await contract.setInfo(name, age);
          showStatus(elements.setInfoStatus, `交易已发送，交易哈希: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.setInfoStatus, `设置成功！区块号: ${receipt.blockNumber}`, "success");

          elements.nameInput.val("");
          elements.ageInput.val("");

        } catch (error) {
          console.error("设置信息失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付 Gas 费用";
          }

          showStatus(elements.setInfoStatus, `设置失败: ${errorMessage}`, "error");
        }
      }

      // 获取信息
      async function getInfo() {
        if (!contract) {
          showStatus(elements.getInfoResult, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus(elements.getInfoResult, "正在获取信息...", "info", true);
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(elements.getInfoResult, `当前信息 - 姓名: "${name}", 年龄: ${age.toString()}`, "success");
          } else {
            showStatus(elements.getInfoResult, "暂无信息或信息为空", "warning");
          }
        } catch (error) {
          console.error("获取信息失败:", error);
          showStatus(elements.getInfoResult, `获取失败: ${error.message}`, "error");
        }
      }

      // 存入ETH
      async function depositEth() {
        if (!contract) {
          showStatus(elements.depositStatus, "请先连接钱包", "error");
          return;
        }

        const amount = elements.depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.depositStatus, "请输入有效的存款金额", "error");
          return;
        }

        try {
          showStatus(elements.depositStatus, `正在存入 ${amount} ETH...`, "info", true);

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(elements.depositStatus, `交易已发送，交易哈希: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.depositStatus, `存款成功！区块号: ${receipt.blockNumber}`, "success");

          elements.depositAmount.val("");
          await getContractBalance();

        } catch (error) {
          console.error("存款失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付交易费用";
          }

          showStatus(elements.depositStatus, `存款失败: ${errorMessage}`, "error");
        }
      }

      // 提取ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus(elements.withdrawStatus, "请先连接钱包", "error");
          return;
        }

        const amount = elements.withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.withdrawStatus, "请输入有效的提取金额", "error");
          return;
        }

        try {
          showStatus(elements.withdrawStatus, `正在提取 ${amount} ETH...`, "info", true);

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(elements.withdrawStatus, `交易已发送，交易哈希: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.withdrawStatus, `提取成功！区块号: ${receipt.blockNumber}`, "success");

          elements.withdrawAmount.val("");
          await getContractBalance();

        } catch (error) {
          console.error("提取失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付 Gas 费用";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "合约余额不足";
          }

          showStatus(elements.withdrawStatus, `提取失败: ${errorMessage}`, "error");
        }
      }

      // 转移到所有者
      async function transferToOwner() {
        if (!contract) {
          showStatus(elements.transferToOwnerStatus, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus(elements.transferToOwnerStatus, "正在转移资金到所有者...", "info", true);

          const tx = await contract.transferToOwner();
          showStatus(elements.transferToOwnerStatus, `交易已发送，交易哈希: ${tx.hash}`, "info");

          const receipt = await tx.wait();
          showStatus(elements.transferToOwnerStatus, `转移成功！区块号: ${receipt.blockNumber}`, "success");

          await getContractBalance();

        } catch (error) {
          console.error("转移失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "只有合约所有者才能执行此操作";
          } else if (error.message.includes("No balance")) {
            errorMessage = "合约没有余额可转移";
          }

          showStatus(elements.transferToOwnerStatus, `转移失败: ${errorMessage}`, "error");
        }
      }

      // 监听账户和网络变化
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // 事件监听器设置
      $(document).ready(function () {
        // 绑定事件
        elements.connectWallet.on("click", connectWallet);
        elements.disconnectWallet.on("click", disconnectWallet);
        elements.setInfoBtn.on("click", setInfo);
        elements.getInfoBtn.on("click", getInfo);
        elements.depositBtn.on("click", depositEth);
        elements.withdrawBtn.on("click", withdrawEth);
        elements.transferToOwnerBtn.on("click", transferToOwner);

        // 回车键支持
        elements.nameInput.add(elements.ageInput).on("keypress", function(e) {
          if (e.which === 13) setInfo();
        });

        elements.depositAmount.on("keypress", function(e) {
          if (e.which === 13) depositEth();
        });

        elements.withdrawAmount.on("keypress", function(e) {
          if (e.which === 13) withdrawEth();
        });

        // 检查是否已连接
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("检查连接状态失败:", error);
            });
        }
      });
    </script>
  </body>
</html>