<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp - Enhanced</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="./index.css" />
    <script src="./index.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- å¢å¼ºçš„å¤´éƒ¨ -->
      <div class="header">
        <h1>Chalee DApp</h1>
        <p class="subtitle">ç°ä»£åŒ–çš„ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦äº¤äº’å¹³å°</p>
      </div>

      <!-- é’±åŒ…è¿æ¥å¡ç‰‡ -->
      <div class="card glass" style="margin-bottom: 20px">
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="connectionText">æœªè¿æ¥</span>
        </div>
        <h3><span class="card-icon">ğŸ”—</span>é’±åŒ…è¿æ¥</h3>
        <div class="input-group">
          <div class="input-row">
            <button id="connectWallet" class="btn btn-primary">
              è¿æ¥ MetaMask
            </button>
            <button id="disconnectWallet" class="btn btn-danger hidden">
              æ–­å¼€è¿æ¥
            </button>
          </div>
        </div>
        <div id="accountInfo" class="account-info hidden"></div>
        <div id="connectionStatus"></div>
        <div id="ownerInfo"></div>
        <div id="balanceDisplay"></div>
      </div>

      <!-- åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ -->
      <div class="grid" id="grid">
        <!-- ä¿¡æ¯ç®¡ç†å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“</span>ä¿¡æ¯ç®¡ç†</h3>
          <div class="input-group">
            <div class="input-row">
              <input type="text" id="nameInput" placeholder="è¾“å…¥å§“å" />
              <input type="number" id="ageInput" placeholder="è¾“å…¥å¹´é¾„" />
            </div>
            <button id="setInfoBtn" class="btn">è®¾ç½®ä¿¡æ¯</button>
          </div>
          <div id="setInfoStatus"></div>

          <div class="input-group" style="margin-top: 25px">
            <button id="getInfoBtn" class="btn btn-success">
              è·å–å½“å‰ä¿¡æ¯
            </button>
          </div>
          <div id="getInfoResult"></div>
        </div>

        <!-- å­˜æ¬¾åŠŸèƒ½å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“¥</span>å­˜å…¥ ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="depositAmount"
              placeholder="è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆETHï¼‰"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="æœ€å°å­˜æ¬¾é‡‘é¢ä¸º 0.001 ETH"
            />
            <button id="depositBtn" class="btn btn-success">å­˜å…¥</button>
          </div>
          <div id="depositStatus"></div>
        </div>

        <!-- ææ¬¾åŠŸèƒ½å¡ç‰‡ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ“¤</span>æå– ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="withdrawAmount"
              placeholder="è¾“å…¥æå–é‡‘é¢ï¼ˆETHï¼‰"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="ç¡®ä¿åˆçº¦æœ‰è¶³å¤Ÿä½™é¢"
            />
            <button id="withdrawBtn" class="btn btn-primary">æå–</button>
          </div>
          <div id="withdrawStatus"></div>
        </div>
        <!-- åˆ›å»ºçº¢åŒ…  -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ</span>åˆ›å»ºçº¢åŒ…</h3>
          <div class="input-group">
            <div class="input-row">
              <!-- çº¢åŒ…é‡‘é¢ -->
              <input
                type="number"
                id="redPacketAmountInput"
                placeholder="è¾“å…¥çº¢åŒ…é‡‘é¢ï¼ˆETHï¼‰"
                step="0.001"
                min="0.001"
              />
              <!-- çº¢åŒ…ä¸ªæ•° -->
              <input
                type="number"
                id="redPacketCountInput"
                placeholder="è¾“å…¥çº¢åŒ…ä¸ªæ•°"
                min="1"
                value="1"
              />
            </div>
            <button id="createRedPacketBtn" class="btn btn-warning">
              åˆ›å»ºçº¢åŒ…
            </button>
          </div>
        </div>
        <!-- çº¢åŒ…çŠ¶æ€ -->
        <div class="card glass">
          <h3><span class="card-icon">ğŸ‰</span>çº¢åŒ…çŠ¶æ€</h3>
          <div id="redPacketStatus"></div>
        </div>
      </div>

      <div class="footer-space"></div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;

      console.log("Chalee DApp - Enhanced Loaded",CONTRACT_ADDRESS);

      // DOM å…ƒç´ 
      const elements = {
        connectWallet: $("#connectWallet"),
        disconnectWallet: $("#disconnectWallet"),
        accountInfo: $("#accountInfo"),
        connectionStatus: $("#connectionStatus"),
        statusDot: $("#statusDot"),
        connectionText: $("#connectionText"),
        ownerInfo: $("#ownerInfo"),
        balanceDisplay: $("#balanceDisplay"),

        // ä¿¡æ¯ç®¡ç†
        nameInput: $("#nameInput"),
        ageInput: $("#ageInput"),
        setInfoBtn: $("#setInfoBtn"),
        setInfoStatus: $("#setInfoStatus"),
        getInfoBtn: $("#getInfoBtn"),
        getInfoResult: $("#getInfoResult"),

        // å­˜æ¬¾
        depositAmount: $("#depositAmount"),
        depositBtn: $("#depositBtn"),
        depositStatus: $("#depositStatus"),

        // ææ¬¾
        withdrawAmount: $("#withdrawAmount"),
        withdrawBtn: $("#withdrawBtn"),
        withdrawStatus: $("#withdrawStatus"),

        grid: $("#grid"),
        // çº¢åŒ…åŠŸèƒ½
        redPacketAmountInput: $("#redPacketAmountInput"),
        redPacketCountInput: $("#redPacketCountInput"),
        createRedPacketBtn: $("#createRedPacketBtn"),
        createRedPacketStatus: $("#createRedPacketStatus"),
      };

      // æ£€æŸ¥ MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask å·²å®‰è£…");
          return true;
        } else {
          showStatus(
            elements.connectionStatus,
            "è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•ï¼",
            "error"
          );
          return false;
        }
      }

      // è¿æ¥é’±åŒ…
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus(
            elements.connectionStatus,
            "æ­£åœ¨è¿æ¥é’±åŒ…...",
            "info",
            true
          );

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          contract = new ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            signer
          );

          updateConnectionUI(true);
          updateConnectionStatus(true, currentAccount);
          showStatus(elements.connectionStatus, "é’±åŒ…è¿æ¥æˆåŠŸï¼", "success");

          // è·å–åˆçº¦ä¿¡æ¯
          await Promise.all([getOwnerInfo(), getContractBalance()]);
        } catch (error) {
          console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
          showStatus(
            elements.connectionStatus,
            `è¿æ¥å¤±è´¥: ${error.message}`,
            "error"
          );
          updateConnectionStatus(false);
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        updateConnectionUI(false);
        updateConnectionStatus(false);
        showStatus(elements.connectionStatus, "å·²æ–­å¼€é’±åŒ…è¿æ¥", "info");
        clearAllResults();
      }

      // è·å–åˆçº¦æ‰€æœ‰è€…ä¿¡æ¯
      async function getOwnerInfo() {
        if (!contract) return;

        try {
          const owner = await contract.owner();
          const isCurrentUserOwner =
            owner.toLowerCase() === currentAccount.toLowerCase();

          const ownerDisplay = `
            <div class="owner-info ${isCurrentUserOwner ? "owner-badge" : ""}">
              <div style="font-size: 0.9rem; opacity: 0.9;">
                ${
                  isCurrentUserOwner
                    ? "æ‚¨æ‹¥æœ‰åˆçº¦çš„å®Œå…¨æ§åˆ¶æƒ"
                    : "æ‚¨ä¸æ˜¯åˆçº¦æ‰€æœ‰è€…ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™"
                }
              </div>
            </div>
          `;

          elements.ownerInfo.html(ownerDisplay);

          const ownerCardDisplay = `
          <!-- æ‰€æœ‰è€…æ“ä½œå¡ç‰‡ -->
        <div class="card glass" id="ownerCard">
          <h3><span class="card-icon">ğŸ†</span>æ‰€æœ‰è€…æ“ä½œ</h3>
          <div class="input-group">
            <button id="transferToOwnerBtn" class="btn btn-warning tooltip" data-tooltip="åªæœ‰åˆçº¦æ‰€æœ‰è€…å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ">
              è½¬ç§»æ‰€æœ‰ä½™é¢åˆ°åˆçº¦æ‰€æœ‰è€…
            </button>
          </div>
          <div id="transferToOwnerStatus"></div>
        </div>
          `;

          // æ§åˆ¶æ‰€æœ‰è€…æ“ä½œå¡ç‰‡æ˜¾ç¤º
          if (isCurrentUserOwner) {
            elements.grid.append(ownerCardDisplay);
            $("#transferToOwnerBtn").on("click", transferToOwner);
          } else {
            $("#ownerCard").remove();
          }
        } catch (error) {
          console.error("è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥:", error);
          showStatus(
            elements.ownerInfo,
            `è·å–æ‰€æœ‰è€…ä¿¡æ¯å¤±è´¥: ${error.message}`,
            "error"
          );
        }
      }

      // è·å–åˆçº¦ä½™é¢
      async function getContractBalance() {
        if (!contract) return;

        try {
          const balance = await contract.getBalance();
          const balanceInEth = formatEth(balance);

          elements.balanceDisplay.html(`
            <div class="balance-display">
              <div class="balance-amount">Î ${balanceInEth}</div>
              <div class="balance-label">åˆçº¦å½“å‰ä½™é¢</div>
            </div>
          `);
        } catch (error) {
          console.error("è·å–ä½™é¢å¤±è´¥:", error);
          showStatus(
            elements.balanceDisplay,
            `è·å–ä½™é¢å¤±è´¥: ${error.message}`,
            "error"
          );
        }
      }

      // è®¾ç½®ä¿¡æ¯
      async function setInfo() {
        if (!contract) {
          showStatus(elements.setInfoStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const name = elements.nameInput.val().trim();
        const age = parseInt(elements.ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus(elements.setInfoStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å§“åå’Œå¹´é¾„", "error");
          return;
        }

        try {
          showStatus(elements.setInfoStatus, "æ­£åœ¨è®¾ç½®ä¿¡æ¯...", "info", true);

          const tx = await contract.setInfo(name, age);
          showStatus(
            elements.setInfoStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.setInfoStatus,
            `è®¾ç½®æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          elements.nameInput.val("");
          elements.ageInput.val("");
        } catch (error) {
          console.error("è®¾ç½®ä¿¡æ¯å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨";
          }

          showStatus(
            elements.setInfoStatus,
            `è®¾ç½®å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // è·å–ä¿¡æ¯
      async function getInfo() {
        if (!contract) {
          showStatus(elements.getInfoResult, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus(elements.getInfoResult, "æ­£åœ¨è·å–ä¿¡æ¯...", "info", true);
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(
              elements.getInfoResult,
              `å½“å‰ä¿¡æ¯ - å§“å: "${name}", å¹´é¾„: ${age.toString()}`,
              "success"
            );
          } else {
            showStatus(elements.getInfoResult, "æš‚æ— ä¿¡æ¯æˆ–ä¿¡æ¯ä¸ºç©º", "warning");
          }
        } catch (error) {
          console.error("è·å–ä¿¡æ¯å¤±è´¥:", error);
          showStatus(
            elements.getInfoResult,
            `è·å–å¤±è´¥: ${error.message}`,
            "error"
          );
        }
      }

      // å­˜å…¥ETH
      async function depositEth() {
        if (!contract) {
          showStatus(elements.depositStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = elements.depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.depositStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢", "error");
          return;
        }

        try {
          showStatus(
            elements.depositStatus,
            `æ­£åœ¨å­˜å…¥ ${amount} ETH...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(
            elements.depositStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.depositStatus,
            `å­˜æ¬¾æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          elements.depositAmount.val("");
          await getContractBalance();
        } catch (error) {
          console.error("å­˜æ¬¾å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜äº¤æ˜“è´¹ç”¨";
          }

          showStatus(
            elements.depositStatus,
            `å­˜æ¬¾å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // æå–ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus(elements.withdrawStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = elements.withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.withdrawStatus, "è¯·è¾“å…¥æœ‰æ•ˆçš„æå–é‡‘é¢", "error");
          return;
        }

        try {
          showStatus(
            elements.withdrawStatus,
            `æ­£åœ¨æå– ${amount} ETH...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(
            elements.withdrawStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.withdrawStatus,
            `æå–æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          elements.withdrawAmount.val("");
          await getContractBalance();
        } catch (error) {
          console.error("æå–å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "åˆçº¦ä½™é¢ä¸è¶³";
          }

          showStatus(
            elements.withdrawStatus,
            `æå–å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // è½¬ç§»åˆ°æ‰€æœ‰è€…
      async function transferToOwner() {
        if (!contract) {
          showStatus(elements.transferToOwnerStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        try {
          showStatus(
            elements.transferToOwnerStatus,
            "æ­£åœ¨è½¬ç§»èµ„é‡‘åˆ°æ‰€æœ‰è€…...",
            "info",
            true
          );

          const tx = await contract.transferToOwner();
          showStatus(
            elements.transferToOwnerStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.transferToOwnerStatus,
            `è½¬ç§»æˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          await getContractBalance();
        } catch (error) {
          console.error("è½¬ç§»å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "åªæœ‰åˆçº¦æ‰€æœ‰è€…æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ";
          } else if (error.message.includes("No balance")) {
            errorMessage = "åˆçº¦æ²¡æœ‰ä½™é¢å¯è½¬ç§»";
          }

          showStatus(
            elements.transferToOwnerStatus,
            `è½¬ç§»å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // çº¢åŒ…åŠŸèƒ½
      // åˆ›å»ºçº¢åŒ…
      async function createRedPacket() {
        if (!contract) {
          showStatus(elements.createRedPacketStatus, "è¯·å…ˆè¿æ¥é’±åŒ…", "error");
          return;
        }

        const amount = elements.redPacketAmountInput.val();
        const count = parseInt(elements.redPacketCountInput.val());

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(
            elements.createRedPacketStatus,
            "è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…é‡‘é¢",
            "error"
          );
          return;
        }

        if (isNaN(count) || count <= 0) {
          showStatus(
            elements.createRedPacketStatus,
            "è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°",
            "error"
          );
          return;
        }

        try {
          showStatus(
            elements.createRedPacketStatus,
            `æ­£åœ¨åˆ›å»ºçº¢åŒ…...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.sendRedPacket(false, count, amountWei);

          showStatus(
            elements.createRedPacketStatus,
            `äº¤æ˜“å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.createRedPacketStatus,
            `çº¢åŒ…åˆ›å»ºæˆåŠŸï¼åŒºå—å·: ${receipt.blockNumber}`,
            "success"
          );

          elements.redPacketAmountInput.val("");
          elements.redPacketCountInput.val("1");
        } catch (error) {
          console.error("åˆ›å»ºçº¢åŒ…å¤±è´¥:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨";
          }

          showStatus(
            elements.createRedPacketStatus,
            `åˆ›å»ºçº¢åŒ…å¤±è´¥: ${errorMessage}`,
            "error"
          );
        }
      }

      // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
      $(document).ready(function () {
        // ç»‘å®šäº‹ä»¶
        elements.connectWallet.on("click", connectWallet);
        elements.disconnectWallet.on("click", disconnectWallet);
        elements.setInfoBtn.on("click", setInfo);
        elements.getInfoBtn.on("click", getInfo);
        elements.depositBtn.on("click", depositEth);
        elements.withdrawBtn.on("click", withdrawEth);
        elements.createRedPacketBtn.on("click", createRedPacket);

        // å›è½¦é”®æ”¯æŒ
        elements.nameInput.add(elements.ageInput).on("keypress", function (e) {
          if (e.which === 13) setInfo();
        });

        elements.depositAmount.on("keypress", function (e) {
          if (e.which === 13) depositEth();
        });

        elements.withdrawAmount.on("keypress", function (e) {
          if (e.which === 13) withdrawEth();
        });

        // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥:", error);
            });
        }
      });
    </script>
  </body>
</html>
