<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chalee DApp - Enhanced</title>
    <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="./index.css" />
    <script src="./index.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- 增强的头部 -->
      <div class="header">
        <h1>Chalee DApp</h1>
        <p class="subtitle">现代化的以太坊智能合约交互平台</p>
      </div>

      <!-- 钱包连接卡片 -->
      <div class="card glass" style="margin-bottom: 20px">
        <!-- 连接状态指示器 -->
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="connectionText">未连接</span>
        </div>
        <h3><span class="card-icon">🔗</span>钱包连接</h3>
        <div class="input-group">
          <div class="input-row">
            <button id="connectWallet" class="btn btn-primary">
              连接 MetaMask
            </button>
            <button id="disconnectWallet" class="btn btn-danger hidden">
              断开连接
            </button>
          </div>
        </div>
        <div id="accountInfo" class="account-info hidden"></div>
        <div id="connectionStatus"></div>
        <div id="ownerInfo"></div>
        <div id="balanceDisplay"></div>
      </div>

      <!-- 功能卡片网格 -->
      <div class="grid" id="grid">
        <!-- 信息管理卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📝</span>信息管理</h3>
          <div class="input-group">
            <div class="input-row">
              <input type="text" id="nameInput" placeholder="输入姓名" />
              <input type="number" id="ageInput" placeholder="输入年龄" />
            </div>
            <button id="setInfoBtn" class="btn">设置信息</button>
          </div>
          <div id="setInfoStatus"></div>

          <div class="input-group" style="margin-top: 25px">
            <button id="getInfoBtn" class="btn btn-success">
              获取当前信息
            </button>
          </div>
          <div id="getInfoResult"></div>
        </div>

        <!-- 存款功能卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📥</span>存入 ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="depositAmount"
              placeholder="输入存款金额（ETH）"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="最小存款金额为 0.001 ETH"
            />
            <button id="depositBtn" class="btn btn-success">存入</button>
          </div>
          <div id="depositStatus"></div>
        </div>

        <!-- 提款功能卡片 -->
        <div class="card glass">
          <h3><span class="card-icon">📤</span>提取 ETH</h3>
          <div class="input-group">
            <input
              type="number"
              id="withdrawAmount"
              placeholder="输入提取金额（ETH）"
              step="0.001"
              min="0.001"
              class="tooltip"
              data-tooltip="确保合约有足够余额"
            />
            <button id="withdrawBtn" class="btn btn-primary">提取</button>
          </div>
          <div id="withdrawStatus"></div>
        </div>
        <!-- 创建红包  -->
        <div class="card glass">
          <h3><span class="card-icon">🎁</span>创建红包</h3>
          <div class="input-group">
            <div class="input-row">
              <!-- 红包金额 -->
              <input
                type="number"
                id="redPacketAmountInput"
                placeholder="输入红包金额（ETH）"
                step="0.001"
                min="0.001"
              />
              <!-- 红包个数 -->
              <input
                type="number"
                id="redPacketCountInput"
                placeholder="输入红包个数"
                min="1"
                value="1"
              />
            </div>
            <button id="createRedPacketBtn" class="btn btn-warning">
              创建红包
            </button>
          </div>
        </div>
        <!-- 红包状态 -->
        <div class="card glass">
          <h3><span class="card-icon">🎉</span>红包状态</h3>
          <div id="redPacketStatus"></div>
        </div>
      </div>

      <div class="footer-space"></div>
    </div>

    <script>
      // 全局变量
      let provider = null;
      let signer = null;
      let contract = null;
      let currentAccount = null;

      console.log("Chalee DApp - Enhanced Loaded",CONTRACT_ADDRESS);

      // DOM 元素
      const elements = {
        connectWallet: $("#connectWallet"),
        disconnectWallet: $("#disconnectWallet"),
        accountInfo: $("#accountInfo"),
        connectionStatus: $("#connectionStatus"),
        statusDot: $("#statusDot"),
        connectionText: $("#connectionText"),
        ownerInfo: $("#ownerInfo"),
        balanceDisplay: $("#balanceDisplay"),

        // 信息管理
        nameInput: $("#nameInput"),
        ageInput: $("#ageInput"),
        setInfoBtn: $("#setInfoBtn"),
        setInfoStatus: $("#setInfoStatus"),
        getInfoBtn: $("#getInfoBtn"),
        getInfoResult: $("#getInfoResult"),

        // 存款
        depositAmount: $("#depositAmount"),
        depositBtn: $("#depositBtn"),
        depositStatus: $("#depositStatus"),

        // 提款
        withdrawAmount: $("#withdrawAmount"),
        withdrawBtn: $("#withdrawBtn"),
        withdrawStatus: $("#withdrawStatus"),

        grid: $("#grid"),
        // 红包功能
        redPacketAmountInput: $("#redPacketAmountInput"),
        redPacketCountInput: $("#redPacketCountInput"),
        createRedPacketBtn: $("#createRedPacketBtn"),
        createRedPacketStatus: $("#createRedPacketStatus"),
      };

      // 检查 MetaMask
      function checkMetaMask() {
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask 已安装");
          return true;
        } else {
          showStatus(
            elements.connectionStatus,
            "请安装 MetaMask 钱包扩展！",
            "error"
          );
          return false;
        }
      }

      // 连接钱包
      async function connectWallet() {
        if (!checkMetaMask()) return;

        try {
          showStatus(
            elements.connectionStatus,
            "正在连接钱包...",
            "info",
            true
          );

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length === 0) {
            throw new Error("没有找到账户");
          }

          currentAccount = accounts[0];
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          contract = new ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            signer
          );

          updateConnectionUI(true);
          updateConnectionStatus(true, currentAccount);
          showStatus(elements.connectionStatus, "钱包连接成功！", "success");

          // 获取合约信息
          await Promise.all([getOwnerInfo(), getContractBalance()]);
        } catch (error) {
          console.error("连接钱包失败:", error);
          showStatus(
            elements.connectionStatus,
            `连接失败: ${error.message}`,
            "error"
          );
          updateConnectionStatus(false);
        }
      }

      // 断开连接
      function disconnectWallet() {
        provider = null;
        signer = null;
        contract = null;
        currentAccount = null;

        updateConnectionUI(false);
        updateConnectionStatus(false);
        showStatus(elements.connectionStatus, "已断开钱包连接", "info");
        clearAllResults();
      }

      // 获取合约所有者信息
      async function getOwnerInfo() {
        if (!contract) return;

        try {
          const owner = await contract.owner();
          const isCurrentUserOwner =
            owner.toLowerCase() === currentAccount.toLowerCase();

          const ownerDisplay = `
            <div class="owner-info ${isCurrentUserOwner ? "owner-badge" : ""}">
              <div style="font-size: 0.9rem; opacity: 0.9;">
                ${
                  isCurrentUserOwner
                    ? "您拥有合约的完全控制权"
                    : "您不是合约所有者，某些功能可能受限"
                }
              </div>
            </div>
          `;

          elements.ownerInfo.html(ownerDisplay);

          const ownerCardDisplay = `
          <!-- 所有者操作卡片 -->
        <div class="card glass" id="ownerCard">
          <h3><span class="card-icon">🏆</span>所有者操作</h3>
          <div class="input-group">
            <button id="transferToOwnerBtn" class="btn btn-warning tooltip" data-tooltip="只有合约所有者可以执行此操作">
              转移所有余额到合约所有者
            </button>
          </div>
          <div id="transferToOwnerStatus"></div>
        </div>
          `;

          // 控制所有者操作卡片显示
          if (isCurrentUserOwner) {
            elements.grid.append(ownerCardDisplay);
            $("#transferToOwnerBtn").on("click", transferToOwner);
          } else {
            $("#ownerCard").remove();
          }
        } catch (error) {
          console.error("获取所有者信息失败:", error);
          showStatus(
            elements.ownerInfo,
            `获取所有者信息失败: ${error.message}`,
            "error"
          );
        }
      }

      // 获取合约余额
      async function getContractBalance() {
        if (!contract) return;

        try {
          const balance = await contract.getBalance();
          const balanceInEth = formatEth(balance);

          elements.balanceDisplay.html(`
            <div class="balance-display">
              <div class="balance-amount">Ξ ${balanceInEth}</div>
              <div class="balance-label">合约当前余额</div>
            </div>
          `);
        } catch (error) {
          console.error("获取余额失败:", error);
          showStatus(
            elements.balanceDisplay,
            `获取余额失败: ${error.message}`,
            "error"
          );
        }
      }

      // 设置信息
      async function setInfo() {
        if (!contract) {
          showStatus(elements.setInfoStatus, "请先连接钱包", "error");
          return;
        }

        const name = elements.nameInput.val().trim();
        const age = parseInt(elements.ageInput.val());

        if (!name || isNaN(age) || age < 0) {
          showStatus(elements.setInfoStatus, "请输入有效的姓名和年龄", "error");
          return;
        }

        try {
          showStatus(elements.setInfoStatus, "正在设置信息...", "info", true);

          const tx = await contract.setInfo(name, age);
          showStatus(
            elements.setInfoStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.setInfoStatus,
            `设置成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          elements.nameInput.val("");
          elements.ageInput.val("");
        } catch (error) {
          console.error("设置信息失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付 Gas 费用";
          }

          showStatus(
            elements.setInfoStatus,
            `设置失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 获取信息
      async function getInfo() {
        if (!contract) {
          showStatus(elements.getInfoResult, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus(elements.getInfoResult, "正在获取信息...", "info", true);
          const result = await contract.getInfo();
          const [name, age] = result;

          if (name && age.toString() !== "0") {
            showStatus(
              elements.getInfoResult,
              `当前信息 - 姓名: "${name}", 年龄: ${age.toString()}`,
              "success"
            );
          } else {
            showStatus(elements.getInfoResult, "暂无信息或信息为空", "warning");
          }
        } catch (error) {
          console.error("获取信息失败:", error);
          showStatus(
            elements.getInfoResult,
            `获取失败: ${error.message}`,
            "error"
          );
        }
      }

      // 存入ETH
      async function depositEth() {
        if (!contract) {
          showStatus(elements.depositStatus, "请先连接钱包", "error");
          return;
        }

        const amount = elements.depositAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.depositStatus, "请输入有效的存款金额", "error");
          return;
        }

        try {
          showStatus(
            elements.depositStatus,
            `正在存入 ${amount} ETH...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.deposit({ value: amountWei });

          showStatus(
            elements.depositStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.depositStatus,
            `存款成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          elements.depositAmount.val("");
          await getContractBalance();
        } catch (error) {
          console.error("存款失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付交易费用";
          }

          showStatus(
            elements.depositStatus,
            `存款失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 提取ETH
      async function withdrawEth() {
        if (!contract) {
          showStatus(elements.withdrawStatus, "请先连接钱包", "error");
          return;
        }

        const amount = elements.withdrawAmount.val();

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(elements.withdrawStatus, "请输入有效的提取金额", "error");
          return;
        }

        try {
          showStatus(
            elements.withdrawStatus,
            `正在提取 ${amount} ETH...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.withdraw(amountWei);

          showStatus(
            elements.withdrawStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.withdrawStatus,
            `提取成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          elements.withdrawAmount.val("");
          await getContractBalance();
        } catch (error) {
          console.error("提取失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付 Gas 费用";
          } else if (error.message.includes("Insufficient balance")) {
            errorMessage = "合约余额不足";
          }

          showStatus(
            elements.withdrawStatus,
            `提取失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 转移到所有者
      async function transferToOwner() {
        if (!contract) {
          showStatus(elements.transferToOwnerStatus, "请先连接钱包", "error");
          return;
        }

        try {
          showStatus(
            elements.transferToOwnerStatus,
            "正在转移资金到所有者...",
            "info",
            true
          );

          const tx = await contract.transferToOwner();
          showStatus(
            elements.transferToOwnerStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.transferToOwnerStatus,
            `转移成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          await getContractBalance();
        } catch (error) {
          console.error("转移失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.message.includes("Only the owner")) {
            errorMessage = "只有合约所有者才能执行此操作";
          } else if (error.message.includes("No balance")) {
            errorMessage = "合约没有余额可转移";
          }

          showStatus(
            elements.transferToOwnerStatus,
            `转移失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 红包功能
      // 创建红包
      async function createRedPacket() {
        if (!contract) {
          showStatus(elements.createRedPacketStatus, "请先连接钱包", "error");
          return;
        }

        const amount = elements.redPacketAmountInput.val();
        const count = parseInt(elements.redPacketCountInput.val());

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          showStatus(
            elements.createRedPacketStatus,
            "请输入有效的红包金额",
            "error"
          );
          return;
        }

        if (isNaN(count) || count <= 0) {
          showStatus(
            elements.createRedPacketStatus,
            "请输入有效的红包个数",
            "error"
          );
          return;
        }

        try {
          showStatus(
            elements.createRedPacketStatus,
            `正在创建红包...`,
            "info",
            true
          );

          const amountWei = parseEth(amount);
          const tx = await contract.sendRedPacket(false, count, amountWei);

          showStatus(
            elements.createRedPacketStatus,
            `交易已发送，交易哈希: ${tx.hash}`,
            "info"
          );

          const receipt = await tx.wait();
          showStatus(
            elements.createRedPacketStatus,
            `红包创建成功！区块号: ${receipt.blockNumber}`,
            "success"
          );

          elements.redPacketAmountInput.val("");
          elements.redPacketCountInput.val("1");
        } catch (error) {
          console.error("创建红包失败:", error);
          let errorMessage = error.message;

          if (error.code === "ACTION_REJECTED") {
            errorMessage = "用户拒绝了交易";
          } else if (error.code === "INSUFFICIENT_FUNDS") {
            errorMessage = "余额不足支付 Gas 费用";
          }

          showStatus(
            elements.createRedPacketStatus,
            `创建红包失败: ${errorMessage}`,
            "error"
          );
        }
      }

      // 监听账户和网络变化
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (currentAccount && accounts[0] !== currentAccount) {
            connectWallet();
          }
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // 事件监听器设置
      $(document).ready(function () {
        // 绑定事件
        elements.connectWallet.on("click", connectWallet);
        elements.disconnectWallet.on("click", disconnectWallet);
        elements.setInfoBtn.on("click", setInfo);
        elements.getInfoBtn.on("click", getInfo);
        elements.depositBtn.on("click", depositEth);
        elements.withdrawBtn.on("click", withdrawEth);
        elements.createRedPacketBtn.on("click", createRedPacket);

        // 回车键支持
        elements.nameInput.add(elements.ageInput).on("keypress", function (e) {
          if (e.which === 13) setInfo();
        });

        elements.depositAmount.on("keypress", function (e) {
          if (e.which === 13) depositEth();
        });

        elements.withdrawAmount.on("keypress", function (e) {
          if (e.which === 13) withdrawEth();
        });

        // 检查是否已连接
        if (checkMetaMask()) {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            })
            .catch((error) => {
              console.error("检查连接状态失败:", error);
            });
        }
      });
    </script>
  </body>
</html>
